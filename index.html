<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Technological Institute - Academic Scheduler</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf-plugin-autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm0zv5xTNWqSyj4w34Je2yH1Er91iqvKs",
            authDomain: "myscheduler-624e9.firebaseapp.com",
            databaseURL: "https://myscheduler-624e9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myscheduler-624e9",
            storageBucket: "myscheduler-624e9.firebasestorage.app",
            messagingSenderId: "967010876778",
            appId: "1:967010876778:web:f427493c0aa40547383913"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const scheduleRef = ref(db, 'schedules');
        window.schedules = [];

        onValue(scheduleRef, (snapshot) => {
            const data = snapshot.val();
            window.schedules = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            updateFilterList();
            renderMatrix();
            renderManageTable();
        });

        window.addSchedule = function() {
            const entry = {
                subject: document.getElementById('subject').value,
                section: document.getElementById('section').value,
                teacher: document.getElementById('teacher').value,
                room: document.getElementById('room').value,
                day: document.getElementById('day').value,
                start: document.getElementById('startTime').value,
                end: document.getElementById('endTime').value,
                timestamp: Date.now()
            };
            if(!entry.subject || !entry.section) return alert("Please fill in Subject and Section");
            push(scheduleRef, entry);
            alert("Data Saved Successfully!");
        };

        window.deleteEntry = function(key) {
            if(confirm("Are you sure you want to delete this schedule?")) {
                remove(ref(db, `schedules/${key}`));
            }
        };
    </script>

    <style>
        :root { --ark-dark: #0f172a; --ark-red: #be123c; --ark-green: #059669; --ark-orange: #d97706; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        
        .main-container { max-width: 1200px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; }

        /* HEADER BAR */
        .action-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--ark-dark); color: white; padding: 25px 35px; border-radius: 12px; margin-bottom: 25px;
        }
        .action-bar h2 { margin: 0; font-size: 28px; font-weight: 700; }
        .action-bar p { margin: 4px 0 0 0; font-size: 14px; opacity: 0.8; }

        .btn-stack { display: flex; flex-direction: column; gap: 8px; min-width: 160px; }
        .btn-export { border: none; padding: 8px 15px; border-radius: 6px; color: white; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .bg-red { background: var(--ark-red); }
        .bg-green { background: var(--ark-green); }
        .bg-orange { background: var(--ark-orange); }

        /* CAPTURE AREA BRANDING */
        .capture-header {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            border-bottom: 3px solid var(--ark-dark); padding-bottom: 20px; margin-bottom: 20px;
        }
        .capture-logo { height: 70px; width: auto; }
        .capture-title-box h1 { margin: 0; font-size: 22px; color: var(--ark-dark); }
        .capture-title-box p { margin: 2px 0 0 0; font-weight: bold; color: #64748b; font-size: 13px; }

        /* FORM & MATRIX */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        label { display: block; font-size: 11px; font-weight: 800; color: #475569; text-transform: uppercase; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; }

        #captureArea { background: white; padding: 40px; border: 1px solid #e2e8f0; }
        .matrix-table { width: 100%; border-collapse: collapse; }
        .matrix-table th, .matrix-table td { border: 1px solid #94a3b8; padding: 6px; font-size: 10px; text-align: center; }
        .matrix-table th { background: #334155; color: white; }
        
        .manage-section { margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px; }
        .manage-table { width: 100%; border-collapse: collapse; }
        .manage-table th, .manage-table td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-del { color: #be123c; background: #fff1f2; border: 1px solid #fecaca; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="action-bar">
        <div>
            <h2>ARK EXPORT & DATABASE</h2>
            <p>ARK Technological Institute Education System Inc.</p>
        </div>
        <div class="btn-stack">
            <button class="btn-export bg-red" onclick="downloadFullMatrix('pdf')">PDF Matrix</button>
            <button class="btn-export bg-green" onclick="downloadFullMatrix('png')">PNG Matrix</button>
            <button class="btn-export bg-orange" onclick="downloadMasterlist()">PDF Masterlist</button>
        </div>
    </div>

    <div class="input-grid">
        <div><label>Subject</label><input id="subject" type="text" placeholder="Subject Name"></div>
        <div><label>Section</label><input id="section" type="text" placeholder="Section Code"></div>
        <div><label>Teacher</label><input id="teacher" type="text" placeholder="Instructor"></div>
        <div><label>Room</label><input id="room" type="text" placeholder="Room No."></div>
        <div><label>Day</label>
            <select id="day">
                <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
            </select>
        </div>
        <div><label>Start</label><input id="startTime" type="time" value="07:00"></div>
        <div><label>End</label><input id="endTime" type="time" value="08:00"></div>
        <button onclick="addSchedule()" style="background:var(--ark-dark); color:white; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; align-self:end;">SAVE DATA</button>
    </div>

    <div style="margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 8px;">
        <span style="font-weight: bold; font-size: 14px;">Select View:</span>
        <select id="modeSelect" onchange="updateFilterList()" style="padding:6px; border-radius:4px; margin-left:10px;">
            <option value="section">By Section</option>
            <option value="teacher">By Teacher</option>
            <option value="room">By Room</option>
        </select>
        <select id="filterSelector" onchange="renderMatrix()" style="padding:6px; border-radius:4px; width: 220px; margin-left:10px;"></select>
    </div>

    <div id="captureArea">
        <div class="capture-header">
            <img src="images/logo.png" class="capture-logo" alt="LOGO" onerror="this.style.display='none'">
            <div class="capture-title-box">
                <h1>ARK Technological Institute Education System Inc.</h1>
                <p>ACADEMIC SCHEDULING UNIT - OFFICIAL REPORT</p>
            </div>
        </div>

        <h3 id="matrixTitle" style="text-align: center; text-transform: uppercase; text-decoration: underline; margin-bottom: 20px; color: #1e293b;"></h3>
        
        <table class="matrix-table">
            <thead>
                <tr><th style="width: 80px;">TIME</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th><th>SUN</th></tr>
            </thead>
            <tbody id="matrixBody"></tbody>
        </table>
        
        <div style="margin-top: 15px; font-size: 9px; color: #94a3b8; display: flex; justify-content: space-between;">
            <span>Generated: <span id="dtNow"></span></span>
            <span>ARK Official Document</span>
        </div>
    </div>

    <div class="manage-section">
        <h3 style="color: var(--ark-red);">DATABASE MASTERLIST</h3>
        <table class="manage-table">
            <thead>
                <tr><th>Day</th><th>Time</th><th>Subject</th><th>Section</th><th>Instructor</th><th>Action</th></tr>
            </thead>
            <tbody id="manageBody"></tbody>
        </table>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    function updateFilterList() {
        const mode = document.getElementById('modeSelect').value;
        const sel = document.getElementById('filterSelector');
        const vals = [...new Set(window.schedules.map(s => s[mode]))].sort();
        sel.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        renderMatrix();
    }

    function renderMatrix() {
        const mode = document.getElementById('modeSelect').value;
        const filter = document.getElementById('filterSelector').value;
        const tbody = document.getElementById('matrixBody');
        document.getElementById('matrixTitle').innerText = filter ? `${mode}: ${filter}` : "PLEASE SELECT A VIEW";
        document.getElementById('dtNow').innerText = new Date().toLocaleString();
        tbody.innerHTML = '';
        if(!filter) return;

        for (let h = 7; h <= 20; h++) {
            let hourStr = h.toString().padStart(2, '0') + ":00";
            let displayTime = h > 12 ? (h - 12) + ":00 PM" : (h === 12 ? "12:00 PM" : h + ":00 AM");
            let row = `<tr><td style="background:#f1f5f9; font-weight:bold; color:#475569;">${displayTime}</td>`;
            ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].forEach(day => {
                const matches = window.schedules.filter(s => s[mode] === filter && s.day === day && hourStr >= s.start && hourStr < s.end);
                row += `<td>${matches.map(m => `<div style="background:#f0f9ff; padding:4px; margin-bottom:3px; border-radius:4px; color:#0369a1; font-size:9px; border-left:3px solid #0ea5e9; text-align:left;"><b>${m.subject}</b><br>${m.room}</div>`).join('')}</td>`;
            });
            tbody.innerHTML += row + "</tr>";
        }
    }

    function renderManageTable() {
        document.getElementById('manageBody').innerHTML = window.schedules.map(s => `
            <tr>
                <td>${s.day}</td><td>${s.start}-${s.end}</td><td><b>${s.subject}</b></td>
                <td>${s.section}</td><td>${s.teacher}</td>
                <td><button class="btn-del" onclick="deleteEntry('${s.firebaseKey}')">DELETE</button></td>
            </tr>
        `).join('');
    }

    // UPDATED EXPORT ENGINE WITH ERROR HANDLING
    async function downloadFullMatrix(type) {
        const area = document.getElementById('captureArea');
        
        try {
            const canvas = await html2canvas(area, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true,
                height: area.scrollHeight,
                windowHeight: area.scrollHeight,
                backgroundColor: "#ffffff"
            });

            const imgData = canvas.toDataURL('image/png');

            if(type === 'png') {
                const link = document.createElement('a');
                link.href = imgData;
                link.download = 'ARK_Schedule.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const ratio = (pdfWidth - 20) / imgProps.width;
                const finalHeight = imgProps.height * ratio;
                
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, finalHeight);
                pdf.save("ARK_Official_Schedule.pdf");
            }
        } catch (err) {
            console.error("Capture Error:", err);
            alert("Capture failed. Try removing the logo image or check your internet connection.");
        }
    }

    function downloadMasterlist() {
        if(window.schedules.length === 0) return alert("No data to export");
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFontSize(18);
        doc.text("ARK Technological Institute - Masterlist", 14, 15);
        doc.autoTable({
            head: [['Day', 'Time', 'Subject', 'Teacher', 'Section', 'Room']],
            body: window.schedules.map(s => [s.day, `${s.start}-${s.end}`, s.subject, s.teacher, s.section, s.room]),
            startY: 22,
            headStyles: { fillColor: [15, 23, 42] }
        });
        doc.save("ARK_Masterlist_Report.pdf");
    }
</script>
</body>
</html>
