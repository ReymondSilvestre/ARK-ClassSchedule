<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ARK - Academic Scheduler</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --ark-dark: #0f172a; --ark-accent: #3b82f6; --ark-border: #e2e8f0; --row-height: 60px; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #f8fafc; margin: 0; padding: 15px; color: #1e293b; line-height: 1.2; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: 0.2s ease; }
        .login-card { background: white; padding: 35px; border-radius: 16px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .login-card input, .login-card select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .btn-primary { width: 100%; padding: 12px; background: var(--ark-accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-primary:hover { background: #2563eb; }
        .auth-toggle { margin-top: 20px; font-size: 12px; color: #64748b; }
        .auth-toggle span { color: var(--ark-accent); cursor: pointer; font-weight: 700; text-decoration: underline; }

        .forgot-password { display: block; text-align: right; font-size: 11px; color: var(--ark-accent); cursor: pointer; margin-top: -5px; margin-bottom: 10px; font-weight: 600; }
        .forgot-password:hover { text-decoration: underline; }

        .main-container { max-width: 1440px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 15px; }
        
        /* Dashboard Header */
        .dashboard-header { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .company-logo { width: 60px; height: 60px; object-fit: contain; }
        .header-title h1 { margin: 0; font-size: 20px; font-weight: 800; }
        .header-title p { margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .user-badge { 
            background: rgba(255,255,255,0.1); 
            padding: 8px 15px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-logout { 
            background: #ef4444; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 11px;
            transition: 0.2s;
        }
        .btn-logout:hover { background: #dc2626; }

        /* Dashboard Cards */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .dashboard-card { 
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 25px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--card-color);
            transition: width 0.3s ease;
        }
        .dashboard-card:hover::before { width: 8px; }
        .dashboard-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--card-color);
        }
        .dashboard-card.active {
            border-color: var(--card-color);
            background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(59,130,246,0.02) 100%);
        }
        .card-icon { 
            width: 50px; 
            height: 50px; 
            border-radius: 10px; 
            background: var(--card-color); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px;
            margin-bottom: 15px;
        }
        .card-title { 
            font-size: 16px; 
            font-weight: 800; 
            color: #0f172a; 
            margin: 10px 0 5px 0;
        }
        .card-description { 
            font-size: 12px; 
            color: #64748b; 
            line-height: 1.5;
        }
        .card-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
        }

        /* Section Containers */
        .section-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            display: none;
        }
        .section-container.active { display: block; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .section-title {
            font-size: 18px;
            font-weight: 800;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-close-section {
            background: #64748b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 11px;
        }
        .btn-close-section:hover { background: #475569; }

        /* OPTIMIZED PRINT LAYOUT */
        .print-container {
            background: white;
            padding: 0;
            margin: 0 auto;
            max-width: 1200px;
        }

        .matrix-header { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            padding: 15px 20px;
            border-bottom: 3px solid var(--ark-dark);
            background: white;
        }
        .matrix-header .company-logo { 
            width: 55px; 
            height: 55px; 
            object-fit: contain; 
        }
        .matrix-header-text { text-align: center; }
        .matrix-header-text h2 { 
            margin: 0; 
            font-size: 16px; 
            color: var(--ark-dark); 
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        .matrix-header-text p { 
            margin: 3px 0 0 0; 
            font-size: 10px; 
            font-weight: 700; 
            color: #64748b; 
            text-transform: uppercase; 
        }
        .matrix-header-text h3 { 
            margin: 5px 0 0 0; 
            font-size: 13px; 
            color: #3b82f6; 
            font-weight: 800;
            text-transform: uppercase;
        }

        .action-bar { display: flex; justify-content: space-between; align-items: center; background: var(--ark-dark); color: white; padding: 8px 15px; border-radius: 6px; margin-bottom: 15px; }
        .btn-export { border: none; padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; cursor: pointer; font-size: 10px; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-export:hover { opacity: 0.8; transform: translateY(-1px); }

        .input-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; align-items: end; }
        .input-group label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; height: 36px; box-sizing: border-box; }

        /* Settings Panel */
        .settings-panel { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            border: 2px solid #3b82f6; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px;
        }
        .settings-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin-top: 10px;
        }
        .setting-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #bfdbfe;
        }
        .setting-item label {
            display: block;
            font-size: 10px;
            font-weight: 800;
            color: #1e40af;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .setting-item input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 26px;
            appearance: none;
            background: #cbd5e1;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-switch input[type="checkbox"]:checked {
            background: #22c55e;
        }
        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch input[type="checkbox"]:checked::before {
            left: 27px;
        }
        .toggle-label {
            font-size: 11px;
            font-weight: 600;
            color: #475569;
        }
        .enforcement-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 8px;
        }
        .badge-strict {
            background: #fee2e2;
            color: #991b1b;
        }
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Hours Summary Box */
        .hours-summary { 
            background: linear-gradient(135deg, #111111 0%, #000000 50%, #1a1a1a 100%);
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 8px 16px rgba(255, 107, 107, 0.25); 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .hours-summary.over-limit { 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); 
            animation: pulse 2s ease-in-out infinite; 
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }

        .hours-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 15px; }
        .day-hours { 
            background: rgba(255,255,255,0.25); 
            padding: 12px 8px; 
            border-radius: 8px; 
            text-align: center; 
            backdrop-filter: blur(10px); 
            position: relative;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .day-hours:hover {
            background: rgba(255,255,255,0.35);
            transform: translateY(-2px);
        }
        .day-hours.over-limit { 
            background: rgba(255,255,255,0.4); 
            border: 2px solid rgba(255,255,255,0.9);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .day-hours .day-name { font-size: 9px; font-weight: 800; text-transform: uppercase; opacity: 0.95; letter-spacing: 0.5px; }
        .day-hours .hours-value { font-size: 24px; font-weight: 800; margin-top: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .day-hours .limit-badge { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #fef3c7; 
            color: #92400e; 
            font-size: 8px; 
            padding: 3px 7px; 
            border-radius: 10px; 
            font-weight: 800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .day-hours .over-badge { 
            background: #fee2e2; 
            color: #991b1b;
            animation: badgePulse 1.5s ease-in-out infinite;
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .total-hours { 
            background: rgba(255,255,255,0.35); 
            padding: 16px; 
            border-radius: 10px; 
            text-align: center; 
            margin-top: 15px; 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .total-hours .label { font-size: 11px; font-weight: 800; opacity: 0.95; letter-spacing: 1px; }
        .total-hours .value { 
            font-size: 36px; 
            font-weight: 900; 
            margin-top: 6px; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
            letter-spacing: -1px;
        }
        .total-hours .limit-info { 
            font-size: 10px; 
            margin-top: 8px; 
            opacity: 0.9; 
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* OPTIMIZED TABLE FOR PRINTING */
        .matrix-table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed; 
            border: 2px solid #334155; 
            background: #fff;
            font-family: 'Arial', sans-serif;
        }
        .matrix-table th, .matrix-table td { 
            border: 1px solid #cbd5e1; 
            padding: 4px 2px; 
            text-align: center; 
            vertical-align: middle;
            font-size: 9px;
            line-height: 1.2;
        }
        .matrix-table th { 
            background: #334155; 
            color: white; 
            height: 28px; 
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.3px;
            padding: 5px 2px;
        }
        .time-col { 
            background: #f1f5f9 !important; 
            font-weight: 700; 
            color: #0f172a; 
            width: 100px !important; 
            border-right: 2px solid #64748b; 
            font-size: 8px;
            padding: 4px !important;
            text-align: center !important;
            white-space: nowrap;
        }

        /* OPTIMIZED SLOT BOX FOR PRINTING */
        .slot-box { 
            padding: 3px 4px; 
            border-radius: 3px; 
            font-size: 8px; 
            margin: 1px; 
            cursor: grab; 
            border-left: 3px solid #22c55e; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            display: block;
            min-height: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            line-height: 1.3;
            position: relative;
        }
        .slot-box:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .slot-box:hover .slot-actions {
            opacity: 1;
        }
        .slot-box strong { 
            font-size: 9px; 
            color: #0f172a; 
            display: block; 
            font-weight: 800;
            margin-bottom: 2px;
            letter-spacing: 0.2px;
            line-height: 1.2;
            padding-right: 25px;
        }
        .slot-box .room-badge { 
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #1e40af;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 7px;
            font-weight: 700;
            letter-spacing: 0.3px;
            margin-top: 1px;
        }
        .slot-box .info-line {
            color: #475569;
            font-size: 7px;
            margin-top: 2px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        /* Slot Action Buttons */
        .slot-actions {
            position: absolute;
            top: 2px;
            right: 2px;
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .slot-action-btn {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            transition: all 0.2s ease;
            padding: 0;
        }
        .slot-edit-btn {
            background: #3b82f6;
            color: white;
        }
        .slot-edit-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        .slot-delete-btn {
            background: #ef4444;
            color: white;
        }
        .slot-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* Hide actions when printing */
        @media print {
            .slot-actions { display: none !important; }
        }

        .manage-table { width: 100%; border-collapse: collapse; font-size: 11.5px; margin-top: 10px; }
        .manage-table th { background: #f1f5f9; padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 700; }
        .manage-table td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; }

        .hidden { display: none !important; }
        .btn-delete { color: #ef4444; background: none; border: none; cursor: pointer; padding: 4px; }
        .btn-edit { color: #3b82f6; background: none; border: none; cursor: pointer; padding: 4px; margin-right: 5px; }

        /* Admin Styles */
        #adminSection { background: #fff1f2; border: 2px solid #fda4af; padding: 20px; border-radius: 12px; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
        .role-badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #dcfce7; color: #166534; }

        /* Search box */
        #searchBox { padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 320px; font-size: 13px; }
        #clearSearchBtn { padding: 6px 10px; border-radius: 6px; font-size: 12px; }

        /* Warning Alert Box */
        .warning-alert { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .warning-alert i { color: #f59e0b; font-size: 20px; }
        .warning-alert .content { flex: 1; }
        .warning-alert .title { font-weight: 800; font-size: 11px; color: #92400e; margin-bottom: 3px; }
        .warning-alert .message { font-size: 10px; color: #78350f; }

        /* Bulk Download Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-title {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            color: #0f172a;
        }
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .modal-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .modal-option i {
            font-size: 20px;
            color: #3b82f6;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-modal-cancel {
            background: #e2e8f0;
            color: #475569;
        }
        .btn-modal-confirm {
            background: #3b82f6;
            color: white;
        }

        /* Print Optimization */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-container { 
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .matrix-table { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <img src="images/logo.png" alt="Logo" class="company-logo">
        <h2 id="authTitle" style="margin: 0 0 5px 0; color: var(--ark-dark); font-size: 18px;">ARK LOGIN</h2>
        <p id="authDesc" style="font-size: 11px; color: #64748b; margin-bottom: 15px;">Enter credentials to Access Class Schedule Maker</p>

        <input type="email" id="authEmail" placeholder="Email Address">
        <input type="password" id="authPassword" placeholder="Password">

        <span id="forgotPassLink" class="forgot-password" onclick="handleForgotPassword()">Forgot Password?</span>

        <input type="password" id="authConfirmPassword" placeholder="Confirm Password" class="hidden">

        <div id="roleSelection" class="hidden">
            <label style="font-size: 10px; font-weight: 800; color: #64748b; display: block; text-align: left; margin-bottom: -5px;">ACCOUNT TYPE</label>
            <select id="authRole">
                <option value="viewer">Viewer Account (Automatic Access)</option>
                <option value="operator">Operator Account (Requires Approval)</option>
            </select>
        </div>

        <button id="authBtn" class="btn-primary" onclick="handleAuth()">SIGN IN</button>
        <p id="authError" style="color: #ef4444; font-size: 10px; margin-top: 10px; min-height: 12px;"></p>

        <div class="auth-toggle">
            <span id="toggleText">Don't have an account?</span>
            <span id="toggleLink" onclick="toggleAuthMode()">Create Account</span>
        </div>
    </div>
</div>

<!-- Bulk Download Modal -->
<div id="bulkDownloadModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title"><i class="fa-solid fa-file-pdf"></i> Bulk PDF Download</div>
        <div class="modal-options">
            <div class="modal-option" onclick="selectBulkOption('teacher')">
                <i class="fa-solid fa-chalkboard-user"></i>
                <div>
                    <strong>All Teachers</strong>
                    <p style="font-size: 11px; color: #64748b; margin: 0;">Download schedules for all teachers in one PDF</p>
                </div>
            </div>
            <div class="modal-option" onclick="selectBulkOption('section')">
                <i class="fa-solid fa-users"></i>
                <div>
                    <strong>All Sections</strong>
                    <p style="font-size: 11px; color: #64748b; margin: 0;">Download schedules for all sections in one PDF</p>
                </div>
            </div>
            <div class="modal-option" onclick="selectBulkOption('room')">
                <i class="fa-solid fa-door-open"></i>
                <div>
                    <strong>All Rooms</strong>
                    <p style="font-size: 11px; color: #64748b; margin: 0;">Download schedules for all rooms in one PDF</p>
                </div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn-modal btn-modal-cancel" onclick="closeBulkModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="main-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <img src="images/logo.png" alt="Logo" class="company-logo">
            <div class="header-title">
                <h1>ARK ACADEMIC SCHEDULER</h1>
                <p>Technological Institute Education System</p>
            </div>
        </div>
        <div class="header-right">
            <div class="user-badge">
                <i class="fa-solid fa-user"></i>
                <span id="userRoleTag">VIEWER</span>
            </div>
            <button class="btn-logout" onclick="handleLogout()">
                <i class="fa-solid fa-right-from-bracket"></i> LOGOUT
            </button>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div id="dashboardCards" class="dashboard-grid">
        <!-- Admin Panel Card -->
        <div class="dashboard-card admin-only hidden" style="--card-color: #ef4444;" onclick="showSection('adminSection')">
            <div class="card-badge">ADMIN ONLY</div>
            <div class="card-icon"><i class="fa-solid fa-user-shield"></i></div>
            <div class="card-title">Admin Panel</div>
            <div class="card-description">Manage user accounts, approve operators, and control system access</div>
        </div>

        <!-- Encode Schedule Card -->
        <div class="dashboard-card operator-only" style="--card-color: #3b82f6;" onclick="showSection('encodeSection')">
            <div class="card-badge">OPERATOR</div>
            <div class="card-icon"><i class="fa-solid fa-calendar-plus"></i></div>
            <div class="card-title">Encode Schedule</div>
            <div class="card-description">Add, edit, and manage class schedules with conflict detection</div>
        </div>

        <!-- Schedule View Matrix Card -->
        <div class="dashboard-card" style="--card-color: #10b981;" onclick="showSection('matrixSection')">
            <div class="card-icon"><i class="fa-solid fa-table-cells"></i></div>
            <div class="card-title">Schedule View Matrix</div>
            <div class="card-description">View schedules by section, teacher, or room with export options</div>
        </div>

        <!-- Database Masterlist Card -->
        <div class="dashboard-card" style="--card-color: #f59e0b;" onclick="showSection('masterlistSection')">
            <div class="card-icon"><i class="fa-solid fa-database"></i></div>
            <div class="card-title">Database Masterlist</div>
            <div class="card-description">Browse, search, and manage all schedule entries in one place</div>
        </div>
    </div>

    <!-- Admin Section -->
    <div id="adminSection" class="section-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fa-solid fa-user-shield"></i>
                Admin Console
            </div>
            <button class="btn-close-section" onclick="closeSection('adminSection')">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>

        <div class="admin-grid">
            <div>
                <p style="font-size: 11px; font-weight: bold; color: #be123c; margin-bottom: 5px;">PENDING APPROVALS</p>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #fda4af; border-radius: 6px;">
                    <table class="manage-table" style="background: white; margin-top: 0;">
                        <thead><tr><th>Email</th><th>Action</th></tr></thead>
                        <tbody id="pendingUsersBody"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <p style="font-size: 11px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">MANAGE ALL USERS</p>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 6px;">
                    <table class="manage-table" style="background: white; margin-top: 0;">
                        <thead><tr><th>Email</th><th>Role</th><th>Modify</th></tr></thead>
                        <tbody id="allUsersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Encode Schedule Section -->
    <div id="encodeSection" class="section-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fa-solid fa-calendar-plus"></i>
                Encode Schedule
            </div>
            <button class="btn-close-section" onclick="closeSection('encodeSection')">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3 style="margin: 0 0 10px 0; color: #1e40af; font-size: 13px;">
                <i class="fa-solid fa-gear"></i> HOUR LIMIT SETTINGS
                <span id="enforcementBadge" class="enforcement-badge badge-strict">STRICT MODE</span>
            </h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label><i class="fa-solid fa-clock"></i> Daily Hour Limit (per teacher)</label>
                    <input type="number" id="dailyHourLimit" value="8" min="1" max="24" step="0.5" onchange="updateLimitSettings()">
                </div>
                <div class="setting-item">
                    <label><i class="fa-solid fa-shield-halved"></i> Enforcement Mode</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="enforceLimit" checked onchange="updateLimitSettings()">
                        <span class="toggle-label" id="enforceLimitLabel">Strict Enforcement (Block Over-Limit)</span>
                    </div>
                    <p style="font-size: 9px; color: #64748b; margin: 8px 0 0 0; line-height: 1.4;">
                        <strong>Strict:</strong> Prevents saving schedules that exceed the daily limit.<br>
                        <strong>Warning:</strong> Allows saving but shows warning alerts.
                    </p>
                </div>
            </div>
        </div>

        <div class="input-card">
            <div class="input-row">
                <input type="hidden" id="editKey">
                <div class="input-group"><label>Subject</label><input id="subject" type="text" list="subjectList"><datalist id="subjectList"></datalist></div>
                <div class="input-group"><label>Section</label><input id="section" type="text" list="sectionList"><datalist id="sectionList"></datalist></div>
                <div class="input-group"><label>Instructor</label><input id="teacher" type="text" list="teacherList"><datalist id="teacherList"></datalist></div>
                <div class="input-group"><label>Room</label><input id="room" type="text" list="roomList"><datalist id="roomList"></datalist></div>
                <div class="input-group">
                    <label>Day</label>
                    <select id="day">
                        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                        <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                    </select>
                </div>
                <div class="input-group"><label>Start</label><input id="startTime" type="time" value="07:00"></div>
                <div class="input-group"><label>End</label><input id="endTime" type="time" value="08:00"></div>
                <div style="display:flex; align-items:flex-end;">
                    <button id="saveBtn" style="background: var(--ark-dark); color: white; border: none; padding: 0 15px; border-radius: 6px; font-weight: 700; cursor: pointer; height: 36px; font-size: 11px;" onclick="addSchedule()">SAVE</button>
                </div>
            </div>
        </div>

        <!-- Warning Alert for Over-Limit Teachers -->
        <div id="warningAlert" class="warning-alert hidden">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div class="content">
                <div class="title">‚ö†Ô∏è DAILY HOUR LIMIT EXCEEDED</div>
                <div class="message" id="warningMessage"></div>
            </div>
        </div>
    </div>

    <!-- Schedule View Matrix Section -->
    <div id="matrixSection" class="section-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fa-solid fa-table-cells"></i>
                Schedule View Matrix
            </div>
            <button class="btn-close-section" onclick="closeSection('matrixSection')">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>

        <div class="action-bar">
            <div style="font-size: 11px; font-weight: 700;"><i class="fa-solid fa-download"></i> EXPORT OPTIONS</div>
            <div style="display:flex; gap:6px;">
                <button id="resetBtn" class="btn-export operator-only" style="background:#ef4444;" onclick="resetDatabase()">
                    <i class="fa-solid fa-rotate-left"></i> RESET
                </button>
                <button class="btn-export" style="background:#6366f1;" onclick="openBulkModal()">
                    <i class="fa-solid fa-layer-group"></i> BULK PDF
                </button>
                <button class="btn-export" style="background:#dc2626;" onclick="downloadFullMatrix('pdf')">
                    <i class="fa-solid fa-file-pdf"></i> PDF
                </button>
                <button class="btn-export" style="background:#16a34a;" onclick="downloadFullMatrix('png')">
                    <i class="fa-solid fa-image"></i> PNG
                </button>
                <button class="btn-export" style="background:#15803d;" onclick="downloadExcelMasterlist()">
                    <i class="fa-solid fa-file-excel"></i> EXCEL
                </button>
            </div>
        </div>

        <!-- Hours Summary (only shown for teacher view) -->
        <div id="hoursSummary" class="hours-summary hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 15px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.1);"><i class="fa-solid fa-clock"></i> TEACHING HOURS</h3>
                    <p style="margin: 3px 0 0 0; font-size: 11px; opacity: 0.95; font-weight: 600;" id="teacherNameDisplay"></p>
                </div>
            </div>
            <div class="hours-grid" id="hoursGrid"></div>
            <div class="total-hours">
                <div class="label">TOTAL WEEKLY HOURS</div>
                <div class="value" id="totalWeeklyHours">0</div>
                <div class="limit-info" id="limitInfoDisplay">üìö Daily Limit: 8 hours per day</div>
            </div>
        </div>

        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="font-weight: 800; font-size: 10px; color: #64748b;">VIEW:</span>
            <select id="modeSelect" onchange="updateFilterList(true)" style="padding: 4px; font-size: 11px; border-radius: 4px; border: 1px solid #cbd5e1;">
                <option value="section">Section</option>
                <option value="teacher">Instructor</option>
                <option value="room">Room</option>
            </select>
            <select id="filterSelector" onchange="renderMatrix()" style="padding: 4px; font-size: 11px; width: 200px; border: 2px solid #3b82f6; border-radius: 4px;"></select>
        </div>

        <!-- OPTIMIZED PRINT CONTAINER -->
        <div id="captureArea" class="print-container" style="background:white; border: 2px solid #cbd5e1;">
            <div class="matrix-header">
                <img src="images/logo.png" alt="Logo" class="company-logo">
                <div class="matrix-header-text">
                    <h2>ARK TECHNOLOGICAL INSTITUTE EDUCATION SYSTEM INC.</h2>
                    <p>Class Schedule</p>
                    <h3 id="matrixTitle"></h3>
                </div>
            </div>
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th class="time-col">TIME</th>
                        <th>MON</th>
                        <th>TUE</th>
                        <th>WED</th>
                        <th>THU</th>
                        <th>FRI</th>
                        <th>SAT</th>
                        <th>SUN</th>
                    </tr>
                </thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Database Masterlist Section -->
    <div id="masterlistSection" class="section-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fa-solid fa-database"></i>
                Database Masterlist
            </div>
            <button class="btn-close-section" onclick="closeSection('masterlistSection')">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; gap: 8px; margin-bottom: 10px;">
            <div style="display:flex; gap:8px; align-items:center; flex: 1;">
                <input id="searchBox" type="search" placeholder="Search masterlist (subject, section, teacher, room, day, time)" />
                <button id="clearSearchBtn" class="btn-export" style="background:#64748b;" onclick="clearSearch()">
                    <i class="fa-solid fa-xmark"></i> CLEAR
                </button>
            </div>
        </div>

        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px;">
            <table class="manage-table">
                <thead>
                    <tr><th>DAY</th><th>TIME</th><th>SUBJECT</th><th>SECTION</th><th>TEACHER</th><th>ROOM</th><th class="operator-only" style="width: 70px; text-align: center;">ACTIONS</th></tr>
                </thead>
                <tbody id="manageBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDm0zv5xTNWqSyj4w34Je2yH1Er91iqvKs",
        authDomain: "myscheduler-624e9.firebaseapp.com",
        databaseURL: "https://myscheduler-624e9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myscheduler-624e9",
        storageBucket: "myscheduler-624e9.firebasestorage.app",
        messagingSenderId: "967010876778",
        appId: "1:967010876778:web:f427493c0aa40547383913"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const scheduleRef = ref(db, 'schedules');
    const usersRef = ref(db, 'users');
    const settingsRef = ref(db, 'settings');

    let isLoginMode = true;
    let currentUserRole = 'viewer';
    const ADMIN_EMAIL = "reymonde.silvestre@gmail.com";
    let DAILY_HOUR_LIMIT = 8;
    let ENFORCE_LIMIT = true;
    window.schedules = [];

    // --- SECTION NAVIGATION ---
    window.showSection = (sectionId) => {
        document.querySelectorAll('.section-container').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById('dashboardCards').style.display = 'none';
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.dashboard-card').forEach(card => {
            card.classList.remove('active');
        });
    };

    window.closeSection = (sectionId) => {
        document.getElementById(sectionId).classList.remove('active');
        document.getElementById('dashboardCards').style.display = 'grid';
    };

    // --- BULK DOWNLOAD ---
    window.openBulkModal = () => {
        document.getElementById('bulkDownloadModal').classList.add('active');
    };

    window.closeBulkModal = () => {
        document.getElementById('bulkDownloadModal').classList.remove('active');
    };

    window.selectBulkOption = async (type) => {
        closeBulkModal();
        
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);z-index:10001;text-align:center;';
        loadingMsg.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="font-size:30px;color:#3b82f6;"></i><p style="margin-top:15px;font-weight:600;">Generating bulk PDF...</p>';
        document.body.appendChild(loadingMsg);

        try {
            await downloadBulkPDF(type);
        } finally {
            document.body.removeChild(loadingMsg);
        }
    };

    async function downloadBulkPDF(type) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'mm', 'a4');
        
        const values = [...new Set(window.schedules.map(s => (s[type] || '').trim()))].filter(v => v).sort();
        
        if (values.length === 0) {
            alert(`No ${type}s found in the schedule.`);
            return;
        }

        const originalMode = document.getElementById('modeSelect').value;
        const originalFilter = document.getElementById('filterSelector').value;

        for (let i = 0; i < values.length; i++) {
            const value = values[i];
            
            document.getElementById('modeSelect').value = type;
            updateFilterList(false);
            document.getElementById('filterSelector').value = value;
            renderMatrix();

            await new Promise(resolve => setTimeout(resolve, 500));

            const canvas = await html2canvas(document.getElementById('captureArea'), { 
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });
            const img = canvas.toDataURL('image/png');
            
            if (i > 0) {
                pdf.addPage();
            }
            
            // A4 landscape: 297mm x 210mm
            // Leave 10mm margins on each side
            const pageWidth = 297;
            const pageHeight = 210;
            const margin = 10;
            const availableWidth = pageWidth - (margin * 2);
            const availableHeight = pageHeight - (margin * 2);
            
            const imgProps = pdf.getImageProperties(img);
            const imgRatio = imgProps.height / imgProps.width;
            
            let finalWidth = availableWidth;
            let finalHeight = availableWidth * imgRatio;
            
            // If height exceeds available space, scale down
            if (finalHeight > availableHeight) {
                finalHeight = availableHeight;
                finalWidth = finalHeight / imgRatio;
            }
            
            // Center the image
            const xOffset = (pageWidth - finalWidth) / 2;
            const yOffset = (pageHeight - finalHeight) / 2;
            
            pdf.addImage(img, 'PNG', xOffset, yOffset, finalWidth, finalHeight);
        }

        document.getElementById('modeSelect').value = originalMode;
        updateFilterList(false);
        document.getElementById('filterSelector').value = originalFilter;
        renderMatrix();

        const timestamp = new Date().toISOString().split('T')[0];
        pdf.save(`ARK_All_${type}s_${timestamp}.pdf`);
    }

    // --- TIME UTILITIES ---
    function timeToMinutes(t) {
        if (!t) return 0;
        const [hh, mm] = t.split(':').map(Number);
        return hh * 60 + mm;
    }

    function minutesTo12Hr(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${m.toString().padStart(2,'0')}${ampm}`;
    }

    function militaryToAMPM(militaryTime) {
        if (!militaryTime) return '';
        const mins = timeToMinutes(militaryTime);
        return minutesTo12Hr(mins);
    }

    function formatHourRange(h) {
        const startMin = h * 60;
        const endMin = (h + 1) * 60;
        return `${minutesTo12Hr(startMin)}-${minutesTo12Hr(endMin)}`;
    }

    function calculateHours(start, end) {
        const startMin = timeToMinutes(start);
        const endMin = timeToMinutes(end);
        return (endMin - startMin) / 60;
    }

    // --- SETTINGS MANAGEMENT ---
    function loadSettings() {
        onValue(settingsRef, (snapshot) => {
            const settings = snapshot.val();
            if (settings) {
                DAILY_HOUR_LIMIT = settings.dailyHourLimit || 8;
                ENFORCE_LIMIT = settings.enforceLimit !== undefined ? settings.enforceLimit : true;
                
                document.getElementById('dailyHourLimit').value = DAILY_HOUR_LIMIT;
                document.getElementById('enforceLimit').checked = ENFORCE_LIMIT;
                updateLimitSettings();
            }
        });
    }

    window.updateLimitSettings = () => {
        const limitInput = document.getElementById('dailyHourLimit');
        const enforceCheckbox = document.getElementById('enforceLimit');
        const badge = document.getElementById('enforcementBadge');
        const label = document.getElementById('enforceLimitLabel');
        
        DAILY_HOUR_LIMIT = parseFloat(limitInput.value) || 8;
        ENFORCE_LIMIT = enforceCheckbox.checked;
        
        if (ENFORCE_LIMIT) {
            badge.className = 'enforcement-badge badge-strict';
            badge.textContent = 'STRICT MODE';
            label.textContent = 'Strict Enforcement (Block Over-Limit)';
        } else {
            badge.className = 'enforcement-badge badge-warning';
            badge.textContent = 'WARNING MODE';
            label.textContent = 'Warning Only (Allow Over-Limit)';
        }
        
        if (currentUserRole === 'operator') {
            set(settingsRef, {
                dailyHourLimit: DAILY_HOUR_LIMIT,
                enforceLimit: ENFORCE_LIMIT
            });
        }
        
        document.getElementById('limitInfoDisplay').textContent = 
            `üìö Daily Limit: ${DAILY_HOUR_LIMIT} hours per day`;
        
        checkAllTeachersHourLimits();
        renderHoursSummary(document.getElementById('filterSelector').value);
    };

    // --- FORGOT PASSWORD ---
    window.handleForgotPassword = () => {
        const email = document.getElementById('authEmail').value;
        const errorMsg = document.getElementById('authError');
        if (!email) { errorMsg.innerText = "Please enter your email address first."; return; }
        sendPasswordResetEmail(auth, email).then(() => {
            alert("Password reset email sent! Check your Gmail inbox.");
        }).catch(e => errorMsg.innerText = e.message);
    };

    // --- AUTH OBSERVER ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            onValue(ref(db, `users/${user.uid}`), (snapshot) => {
                const userData = snapshot.val();
                if (user.email === ADMIN_EMAIL) {
                    currentUserRole = 'operator';
                    document.getElementById('loginOverlay').classList.add('hidden');
                    initAppUI();
                    return;
                }
                if (!userData) { signOut(auth); return; }
                if (userData.role === 'operator' && userData.status !== 'approved') {
                    alert("Your Operator account is pending approval from Reymonde Silvestre.");
                    signOut(auth);
                } else {
                    currentUserRole = userData.role;
                    document.getElementById('loginOverlay').classList.add('hidden');
                    initAppUI();
                }
            });
        } else {
            document.getElementById('loginOverlay').classList.remove('hidden');
        }
    });

    function initAppUI() {
        document.getElementById('userRoleTag').innerText = currentUserRole.toUpperCase();
        
        const opElements = document.querySelectorAll('.operator-only');
        opElements.forEach(el => {
            if (currentUserRole === 'viewer') el.classList.add('hidden');
            else el.classList.remove('hidden');
        });

        const adminCards = document.querySelectorAll('.admin-only');
        adminCards.forEach(el => {
            if (auth.currentUser?.email === ADMIN_EMAIL) {
                el.classList.remove('hidden');
                setupAdminDashboard();
            } else {
                el.classList.add('hidden');
            }
        });
        
        loadSettings();
        loadDatabase();
    }

    // --- ADMIN DASHBOARD LOGIC ---
    function setupAdminDashboard() {
        onValue(usersRef, (snapshot) => {
            const users = snapshot.val();
            const pendingBody = document.getElementById('pendingUsersBody');
            const allUsersBody = document.getElementById('allUsersBody');
            pendingBody.innerHTML = '';
            allUsersBody.innerHTML = '';
            if (!users) return;

            Object.entries(users).forEach(([uid, val]) => {
                if (val.email === ADMIN_EMAIL) return;

                if (val.role === 'operator' && val.status === 'pending') {
                    pendingBody.innerHTML += `
                        <tr>
                            <td>${val.email}</td>
                            <td>
                                <button onclick="approveUser('${uid}')" style="background:#22c55e; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-check"></i></button>
                                <button onclick="rejectUser('${uid}')" style="background:#ef4444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-x"></i></button>
                            </td>
                        </tr>`;
                }

                allUsersBody.innerHTML += `
                    <tr>
                        <td style="font-size:10px;">${val.email}</td>
                        <td>
                            <select onchange="changeUserRole('${uid}', this.value)" style="font-size:10px; padding:2px;">
                                <option value="viewer" ${val.role === 'viewer' ? 'selected' : ''}>VIEWER</option>
                                <option value="operator" ${val.role === 'operator' ? 'selected' : ''}>OPERATOR</option>
                            </select>
                        </td>
                        <td>
                             <button onclick="rejectUser('${uid}')" class="btn-delete" style="font-size:10px;"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        });
    }

    window.approveUser = (uid) => update(ref(db, `users/${uid}`), { status: 'approved' });
    window.rejectUser = (uid) => { if(confirm("Permanently delete this user access?")) remove(ref(db, `users/${uid}`)); };
    window.changeUserRole = (uid, newRole) => {
        const updateData = { role: newRole };
        if(newRole === 'operator') updateData.status = 'approved';
        update(ref(db, `users/${uid}`), updateData);
        alert("Role updated to " + newRole);
    };

    // --- LOGIN / REGISTER UI TOGGLES ---
    window.toggleAuthMode = () => {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('authTitle');
        const btn = document.getElementById('authBtn');
        const confirmField = document.getElementById('authConfirmPassword');
        const roleSel = document.getElementById('roleSelection');
        const toggleText = document.getElementById('toggleText');
        const toggleLink = document.getElementById('toggleLink');
        const forgotLink = document.getElementById('forgotPassLink');

        if (isLoginMode) {
            title.innerText = "ARK LOGIN";
            btn.innerText = "SIGN IN";
            confirmField.classList.add('hidden');
            roleSel.classList.add('hidden');
            forgotLink.classList.remove('hidden');
            toggleText.innerText = "Don't have an account?";
            toggleLink.innerText = "Create Account";
        } else {
            title.innerText = "CREATE ACCOUNT";
            btn.innerText = "REGISTER";
            confirmField.classList.remove('hidden');
            roleSel.classList.remove('hidden');
            forgotLink.classList.add('hidden');
            toggleText.innerText = "Already have an account?";
            toggleLink.innerText = "Log In Here";
        }
    };

    window.handleAuth = () => {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPassword').value;
        const confirmPass = document.getElementById('authConfirmPassword').value;
        const role = document.getElementById('authRole').value;
        const errorMsg = document.getElementById('authError');

        if (!email || !pass) return errorMsg.innerText = "Please fill all fields.";

        if (isLoginMode) {
            signInWithEmailAndPassword(auth, email, pass).catch(e => errorMsg.innerText = "Login Failed: " + e.message);
        } else {
            if (pass !== confirmPass) return errorMsg.innerText = "Passwords do not match.";
            createUserWithEmailAndPassword(auth, email, pass).then((userCredential) => {
                set(ref(db, 'users/' + userCredential.user.uid), {
                    email: email, role: role,
                    status: role === 'viewer' ? 'approved' : 'pending'
                });
                if(role === 'operator') { alert("Account request sent! Please wait for approval."); signOut(auth); }
            }).catch(e => errorMsg.innerText = "Sign Up Failed: " + e.message);
        }
    };

    window.handleLogout = () => {
        document.querySelectorAll('.section-container').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById('dashboardCards').style.display = 'grid';
        signOut(auth);
    };

    // --- SCHEDULE LOGIC ---
    function loadDatabase() {
        onValue(scheduleRef, (snapshot) => {
            const data = snapshot.val();
            window.schedules = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            updateFilterList(false);
            updateDataLists();
            renderManageTable();
            renderMatrix();
            checkAllTeachersHourLimits();
        });
    }

    function checkDailyHourLimit(newEntry, ignoreKey = null) {
        if (!newEntry.teacher) return null;

        const teacherSchedules = window.schedules.filter(s => 
            s.teacher === newEntry.teacher && 
            s.day === newEntry.day &&
            s.firebaseKey !== ignoreKey
        );

        let totalHours = 0;
        teacherSchedules.forEach(s => {
            totalHours += calculateHours(s.start, s.end);
        });

        const newHours = calculateHours(newEntry.start, newEntry.end);
        const projectedTotal = totalHours + newHours;

        if (projectedTotal > DAILY_HOUR_LIMIT) {
            return {
                exceeded: true,
                currentHours: totalHours,
                newHours: newHours,
                projectedTotal: projectedTotal,
                overBy: projectedTotal - DAILY_HOUR_LIMIT
            };
        }

        return null;
    }

    function checkConflict(newEntry, ignoreKey = null) {
        const conflicts = [];
        const newStart = timeToMinutes(newEntry.start);
        const newEnd = timeToMinutes(newEntry.end);

        if (newEnd <= newStart) {
            conflicts.push("‚ö†Ô∏è INVALID TIME RANGE\nEnd time must be after start time.");
            return conflicts.join("\n\n");
        }

        const hourLimitCheck = checkDailyHourLimit(newEntry, ignoreKey);
        if (hourLimitCheck && ENFORCE_LIMIT) {
            conflicts.push(`‚è∞ DAILY HOUR LIMIT EXCEEDED (STRICT MODE)
Instructor: ${newEntry.teacher}
Day: ${newEntry.day}

Current Hours: ${hourLimitCheck.currentHours.toFixed(1)} hrs
New Schedule: +${hourLimitCheck.newHours.toFixed(1)} hrs
Projected Total: ${hourLimitCheck.projectedTotal.toFixed(1)} hrs

‚ö†Ô∏è EXCEEDS LIMIT BY: ${hourLimitCheck.overBy.toFixed(1)} hours
Daily limit is ${DAILY_HOUR_LIMIT} hours per day.

‚ùå Cannot save in Strict Mode. Either:
‚Ä¢ Reduce the schedule duration
‚Ä¢ Change to Warning Mode in settings`);
        }

        window.schedules.forEach(existing => {
            if (existing.firebaseKey === ignoreKey) return;
            if (existing.day !== newEntry.day) return;
            const exStart = timeToMinutes(existing.start);
            const exEnd = timeToMinutes(existing.end);
            const overlapping = (newStart < exEnd && newEnd > exStart);
            if (!overlapping) return;

            const newStartAMPM = militaryToAMPM(newEntry.start);
            const newEndAMPM = militaryToAMPM(newEntry.end);
            const exStartAMPM = militaryToAMPM(existing.start);
            const exEndAMPM = militaryToAMPM(existing.end);

            if (existing.teacher && newEntry.teacher && existing.teacher === newEntry.teacher) {
                conflicts.push(`üßë‚Äçüè´ INSTRUCTOR CONFLICT
  Instructor: ${existing.teacher}
  Existing: ${existing.subject} (${existing.section})
            ${exStartAMPM} - ${exEndAMPM}
  New: ${newEntry.subject} (${newEntry.section})
       ${newStartAMPM} - ${newEndAMPM}`);
            }

            if (existing.room && newEntry.room && existing.room === newEntry.room) {
                conflicts.push(`üèõÔ∏è ROOM CONFLICT
  Room: ${existing.room}
  Existing: ${existing.subject} (${existing.section})
            ${exStartAMPM} - ${exEndAMPM}
  New: ${newEntry.subject} (${newEntry.section})
       ${newStartAMPM} - ${newEndAMPM}`);
            }

            if (existing.section && newEntry.section && existing.section === newEntry.section) {
                conflicts.push(`üë• SECTION CONFLICT
  Section: ${existing.section}
  Existing: ${existing.subject} by ${existing.teacher}
            ${exStartAMPM} - ${exEndAMPM}
  New: ${newEntry.subject} by ${newEntry.teacher}
       ${newStartAMPM} - ${newEndAMPM}`);
            }
        });

        return conflicts.length ? conflicts.join("\n\n") : null;
    }

    window.addSchedule = () => {
        const key = document.getElementById('editKey').value;
        const entry = {
            subject: document.getElementById('subject').value.trim().toUpperCase(),
            section: document.getElementById('section').value.trim().toUpperCase(),
            teacher: document.getElementById('teacher').value.trim().toUpperCase(),
            room: document.getElementById('room').value.trim().toUpperCase(),
            day: document.getElementById('day').value,
            start: document.getElementById('startTime').value,
            end: document.getElementById('endTime').value
        };
        if(!entry.subject || !entry.section) return alert("Please fill in Subject & Section");
        
        const errorMsg = checkConflict(entry, key || null);
        if(errorMsg) return alert("‚ùå CONFLICT(S) DETECTED\n\n" + errorMsg);
        
        if (!ENFORCE_LIMIT) {
            const hourLimitCheck = checkDailyHourLimit(entry, key || null);
            if (hourLimitCheck) {
                const proceed = confirm(`‚ö†Ô∏è WARNING: Daily Hour Limit Will Be Exceeded
                
Instructor: ${entry.teacher}
Day: ${entry.day}

Current Hours: ${hourLimitCheck.currentHours.toFixed(1)} hrs
New Schedule: +${hourLimitCheck.newHours.toFixed(1)} hrs
Projected Total: ${hourLimitCheck.projectedTotal.toFixed(1)} hrs

‚ö†Ô∏è EXCEEDS LIMIT BY: ${hourLimitCheck.overBy.toFixed(1)} hours
Daily limit is ${DAILY_HOUR_LIMIT} hours per day.

‚ö†Ô∏è Warning Mode is active. Do you want to proceed anyway?`);
                
                if (!proceed) return;
            }
        }
        
        if(key) update(ref(db, `schedules/${key}`), entry);
        else push(scheduleRef, entry);
        clearInputs();
    };

    function clearInputs() {
        document.getElementById('editKey').value = '';
        document.getElementById('subject').value = '';
        document.getElementById('section').value = '';
        document.getElementById('teacher').value = '';
        document.getElementById('room').value = '';
        document.getElementById('saveBtn').innerText = 'SAVE';
    }

    window.editEntry = (key) => {
        const item = window.schedules.find(s => s.firebaseKey === key);
        if(!item) return;
        
        showSection('encodeSection');
        
        document.getElementById('editKey').value = key;
        document.getElementById('subject').value = item.subject;
        document.getElementById('section').value = item.section;
        document.getElementById('teacher').value = item.teacher;
        document.getElementById('room').value = item.room;
        document.getElementById('day').value = item.day;
        document.getElementById('startTime').value = item.start;
        document.getElementById('endTime').value = item.end;
        document.getElementById('saveBtn').innerText = 'UPDATE';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteEntry = (k) => { if(confirm("Delete this entry?")) remove(ref(db, `schedules/${k}`)); };
    window.resetDatabase = () => { if(confirm("‚ö†Ô∏è Reset all schedule data?\n\nThis action cannot be undone.")) set(scheduleRef, null); };

    // --- DRAG AND DROP ---
    window.handleDragStart = (e, k) => { if(currentUserRole === 'viewer') e.preventDefault(); else e.dataTransfer.setData("text", k); };
    window.handleDragOver = (e) => e.preventDefault();
    window.handleDrop = (e, day, start) => {
        e.preventDefault();
        const key = e.dataTransfer.getData("text");
        const entry = window.schedules.find(s => s.firebaseKey === key);
        if(!entry) return;
        const [nh, nm] = start.split(':').map(Number);
        const duration = timeToMinutes(entry.end) - timeToMinutes(entry.start);
        const newStartMin = nh * 60 + nm;
        const newEndMin = newStartMin + duration;
        const endHours = Math.floor(newEndMin/60).toString().padStart(2,'0');
        const endMins = (newEndMin%60).toString().padStart(2,'0');
        const endTime = `${endHours}:${endMins}`;
        const updatedEntry = { ...entry, day, start: start, end: endTime };
        const errorMsg = checkConflict(updatedEntry, key);
        if(errorMsg) return alert("‚ùå CANNOT MOVE - CONFLICT DETECTED\n\n" + errorMsg);
        update(ref(db, `schedules/${key}`), { day, start: start, end: endTime });
    };

    // --- CALCULATE TEACHER HOURS ---
    function calculateTeacherHours(teacherName) {
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const hoursPerDay = {};
        days.forEach(d => hoursPerDay[d] = 0);

        window.schedules
            .filter(s => s.teacher === teacherName)
            .forEach(item => {
                const hours = calculateHours(item.start, item.end);
                hoursPerDay[item.day] += hours;
            });

        const totalHours = Object.values(hoursPerDay).reduce((sum, h) => sum + h, 0);
        return { hoursPerDay, totalHours };
    }

    function renderHoursSummary(teacherName) {
        const summaryBox = document.getElementById('hoursSummary');
        const hoursGrid = document.getElementById('hoursGrid');
        const totalDisplay = document.getElementById('totalWeeklyHours');
        const teacherDisplay = document.getElementById('teacherNameDisplay');

        if (!teacherName) {
            summaryBox.classList.add('hidden');
            return;
        }

        const { hoursPerDay, totalHours } = calculateTeacherHours(teacherName);
        const hasOverLimit = Object.values(hoursPerDay).some(h => h > DAILY_HOUR_LIMIT);

        summaryBox.classList.remove('hidden');
        if (hasOverLimit) {
            summaryBox.classList.add('over-limit');
        } else {
            summaryBox.classList.remove('over-limit');
        }

        teacherDisplay.innerText = teacherName;

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const dayAbbrev = { Monday: "MON", Tuesday: "TUE", Wednesday: "WED", Thursday: "THU", Friday: "FRI", Saturday: "SAT", Sunday: "SUN" };

        hoursGrid.innerHTML = days.map(day => {
            const hours = hoursPerDay[day];
            const isOverLimit = hours > DAILY_HOUR_LIMIT;
            const isAtLimit = hours === DAILY_HOUR_LIMIT;
            let badge = '';
            let overClass = '';

            if (isOverLimit) {
                badge = `<span class="limit-badge over-badge">OVER</span>`;
                overClass = ' over-limit';
            } else if (isAtLimit) {
                badge = `<span class="limit-badge">LIMIT</span>`;
            }

            return `
            <div class="day-hours${overClass}">
                ${badge}
                <div class="day-name">${dayAbbrev[day]}</div>
                <div class="hours-value">${hours.toFixed(1)}</div>
            </div>`;
        }).join('');

        totalDisplay.innerText = totalHours.toFixed(1);
    }

    function checkAllTeachersHourLimits() {
        const warningAlert = document.getElementById('warningAlert');
        const warningMessage = document.getElementById('warningMessage');

        const teachers = [...new Set(window.schedules.map(s => s.teacher))].filter(t => t);
        const violations = [];

        teachers.forEach(teacher => {
            const { hoursPerDay } = calculateTeacherHours(teacher);
            const days = Object.entries(hoursPerDay).filter(([day, hours]) => hours > DAILY_HOUR_LIMIT);

            if (days.length > 0) {
                days.forEach(([day, hours]) => {
                    violations.push({ teacher, day, hours });
                });
            }
        });

        if (violations.length > 0) {
            const messages = violations.map(v => 
                `${v.teacher} on ${v.day}: ${v.hours.toFixed(1)} hours (${(v.hours - DAILY_HOUR_LIMIT).toFixed(1)}hrs over ${DAILY_HOUR_LIMIT}hr limit)`
            );
            warningMessage.innerHTML = messages.join('<br>');
            warningAlert.classList.remove('hidden');
        } else {
            warningAlert.classList.add('hidden');
        }
    }

    // --- RENDERING ---
    window.updateFilterList = (forceReset = false) => {
        const m = document.getElementById('modeSelect').value;
        const sel = document.getElementById('filterSelector');
        const prev = sel.value;
        const vals = [...new Set(window.schedules.map(s => (s[m] || '').trim()))].filter(v => v).sort();
        sel.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        if (!forceReset && prev && vals.includes(prev)) sel.value = prev;
        renderMatrix();
    };

    window.updateDataLists = () => {
        ['subject', 'section', 'teacher', 'room'].forEach(f => {
            const list = document.getElementById(`${f}List`);
            const vals = [...new Set(window.schedules.map(s => s[f]))].filter(v => v).sort();
            list.innerHTML = vals.map(v => `<option value="${v}">`).join('');
        });
    };

    window.renderMatrix = () => {
        const mode = document.getElementById('modeSelect').value;
        const filterVal = document.getElementById('filterSelector').value;
        const body = document.getElementById('matrixBody');
        document.getElementById('matrixTitle').innerText = filterVal ? `${mode.toUpperCase()}: ${filterVal}` : "";
        body.innerHTML = '';

        if (mode === 'teacher' && filterVal) {
            renderHoursSummary(filterVal);
        } else {
            document.getElementById('hoursSummary').classList.add('hidden');
        }

        if(!filterVal) return;
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        for (let h = 7; h <= 18; h++) {
            let tr = document.createElement('tr');
            let slotStart = `${h.toString().padStart(2,'0')}:00`;
            let slotEnd = `${(h+1).toString().padStart(2,'0')}:00`;
            tr.innerHTML = `<td class="time-col">${formatHourRange(h)}</td>`;
            days.forEach(day => {
                let td = document.createElement('td');
                td.setAttribute('ondragover', 'handleDragOver(event)');
                td.setAttribute('ondrop', `handleDrop(event, '${day}', '${slotStart}')`);
                const slotStartMin = timeToMinutes(slotStart);
                const slotEndMin = timeToMinutes(slotEnd);
                window.schedules.filter(s => (s[mode] || '') === filterVal && s.day === day).forEach(item => {
                    const itemStartMin = timeToMinutes(item.start);
                    const itemEndMin = timeToMinutes(item.end);
                    const overlapsSlot = (slotStartMin < itemEndMin && slotEndMin > itemStartMin);
                    if (overlapsSlot) {
                        let div = document.createElement('div');
                        div.className = 'slot-box';
                        div.draggable = (currentUserRole === 'operator');
                        div.setAttribute('ondragstart', `handleDragStart(event, '${item.firebaseKey}')`);
                        
                        let displayInfo = '';
                        if (mode === "section") {
                            displayInfo = item.teacher || 'No Teacher';
                        } else if (mode === "teacher") {
                            displayInfo = item.section || 'No Section';
                        } else if (mode === "room") {
                            displayInfo = `${item.section || 'No Section'}‚Ä¢${item.teacher || 'No Teacher'}`;
                        }
                        
                        // Action buttons (only for operators)
                        const actionButtons = currentUserRole === 'operator' ? `
                            <div class="slot-actions">
                                <button class="slot-action-btn slot-edit-btn" onclick="event.stopPropagation(); editEntry('${item.firebaseKey}')" title="Edit">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="slot-action-btn slot-delete-btn" onclick="event.stopPropagation(); deleteEntry('${item.firebaseKey}')" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        ` : '';
                        
                        div.innerHTML = `
                            ${actionButtons}
                            <strong>${item.subject}</strong>
                            <span class="room-badge">${item.room || 'No Room'}</span>
                            <div class="info-line">${displayInfo}</div>
                        `;
                        td.appendChild(div);
                    }
                });
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
    };

    function renderManageTable() {
        const q = (document.getElementById('searchBox') ? document.getElementById('searchBox').value.trim().toLowerCase() : '');
        const filtered = window.schedules.filter(s => {
            if (!q) return true;
            const combined = [
                s.subject || '',
                s.section || '',
                s.teacher || '',
                s.room || '',
                s.day || '',
                `${s.start || ''}-${s.end || ''}`,
                s.firebaseKey || ''
            ].join(' ').toLowerCase();
            return combined.includes(q);
        });

        document.getElementById('manageBody').innerHTML = filtered.map(s => {
            const actionsClass = currentUserRole === 'viewer' ? 'hidden' : '';
            const timeDisplay = `${militaryToAMPM(s.start)} - ${militaryToAMPM(s.end)}`;
            return `
            <tr>
                <td><b>${s.day ? s.day.substring(0,3) : ''}</b></td>
                <td>${timeDisplay}</td>
                <td style="color:#2563eb; font-weight:600">${s.subject}</td>
                <td>${s.section}</td>
                <td>${s.teacher}</td>
                <td>${s.room}</td>
                <td class="${actionsClass}" style="text-align: center;">
                    <button onclick="editEntry('${s.firebaseKey}')" class="btn-edit"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteEntry('${s.firebaseKey}')" class="btn-delete"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    window.clearSearch = () => {
        const sb = document.getElementById('searchBox');
        if (sb) {
            sb.value = '';
            renderManageTable();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const sb = document.getElementById('searchBox');
        if (sb) {
            sb.addEventListener('input', () => {
                renderManageTable();
            });
        }
    });

    // --- EXPORTS ---
    window.downloadFullMatrix = async (type) => {
        const canvas = await html2canvas(document.getElementById('captureArea'), { 
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });
        const img = canvas.toDataURL('image/png');
        
        if(type === 'png') {
            const a = document.createElement('a'); 
            a.href = img; 
            a.download = 'schedule.png'; 
            a.click();
        } else {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            
            // A4 landscape: 297mm x 210mm with 10mm margins
            const pageWidth = 297;
            const pageHeight = 210;
            const margin = 10;
            const availableWidth = pageWidth - (margin * 2);
            const availableHeight = pageHeight - (margin * 2);
            
            const imgProps = pdf.getImageProperties(img);
            const imgRatio = imgProps.height / imgProps.width;
            
            let finalWidth = availableWidth;
            let finalHeight = availableWidth * imgRatio;
            
            if (finalHeight > availableHeight) {
                finalHeight = availableHeight;
                finalWidth = finalHeight / imgRatio;
            }
            
            const xOffset = (pageWidth - finalWidth) / 2;
            const yOffset = (pageHeight - finalHeight) / 2;
            
            pdf.addImage(img, 'PNG', xOffset, yOffset, finalWidth, finalHeight);
            pdf.save('schedule.pdf');
        }
    };

    window.downloadExcelMasterlist = () => {
        const exportData = window.schedules.map(s => ({
            Day: s.day,
            Start: militaryToAMPM(s.start),
            End: militaryToAMPM(s.end),
            Subject: s.subject,
            Section: s.section,
            Teacher: s.teacher,
            Room: s.room
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Masterlist");
        XLSX.writeFile(wb, "ARK_Masterlist.xlsx");
    };
</script>
</body>
</html>
