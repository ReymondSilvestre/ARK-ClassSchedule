<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Technological Institute - Academic Scheduler</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf-plugin-autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm0zv5xTNWqSyj4w34Je2yH1Er91iqvKs",
            authDomain: "myscheduler-624e9.firebaseapp.com",
            databaseURL: "https://myscheduler-624e9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myscheduler-624e9",
            storageBucket: "myscheduler-624e9.firebasestorage.app",
            messagingSenderId: "967010876778",
            appId: "1:967010876778:web:f427493c0aa40547383913"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const scheduleRef = ref(db, 'schedules');
        window.schedules = [];
        window.sortOrder = { field: null, asc: true };

        onValue(scheduleRef, (snapshot) => {
            const data = snapshot.val();
            window.schedules = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            updateFilterList();
            updateDataLists(); 
            renderMatrix();
            renderManageTable();
        });

        // --- Drag and Drop Logic ---
        window.handleDragStart = function(e, key) {
            e.dataTransfer.setData("text/plain", key);
            e.target.style.opacity = "0.4";
        };

        window.handleDragEnd = function(e) {
            e.target.style.opacity = "1";
        };

        window.handleDragOver = function(e) {
            e.preventDefault();
            if(e.currentTarget.classList.contains('matrix-cell')) {
                e.currentTarget.style.background = "#dcfce7"; // Light green highlight
            }
        };

        window.handleDragLeave = function(e) {
            e.currentTarget.style.background = "";
        };

        window.handleDrop = function(e, newDay, newStartTime) {
            e.preventDefault();
            e.currentTarget.style.background = "";
            const key = e.dataTransfer.getData("text/plain");
            const entry = window.schedules.find(s => s.firebaseKey === key);
            
            if(!entry) return;

            // Calculate new end time based on original duration
            const [startH, startM] = entry.start.split(':').map(Number);
            const [endH, endM] = entry.end.split(':').map(Number);
            const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
            
            const [newH, newM] = newStartTime.split(':').map(Number);
            const totalNewEndMinutes = (newH * 60 + newM) + durationMinutes;
            const newEndTime = `${Math.floor(totalNewEndMinutes/60).toString().padStart(2,'0')}:${(totalNewEndMinutes%60).toString().padStart(2,'0')}`;

            // Check for conflicts (excluding the self being dragged)
            const conflict = window.schedules.find(s => 
                s.firebaseKey !== key &&
                s.day === newDay && 
                (newStartTime < s.end && newEndTime > s.start) &&
                (s.room === entry.room || s.teacher === entry.teacher || s.section === entry.section)
            );

            if(conflict) {
                alert(`❌ CONFLICT DETECTED\nCannot move to ${newDay} at ${newStartTime}.\nSlot is occupied by: ${conflict.subject} (${conflict.section})`);
                return;
            }

            // Update Database
            const updates = {};
            updates[`schedules/${key}/day`] = newDay;
            updates[`schedules/${key}/start`] = newStartTime;
            updates[`schedules/${key}/end`] = newEndTime;
            
            update(ref(db), updates)
                .then(() => console.log("Schedule updated via drag!"))
                .catch(err => alert("Error updating schedule: " + err));
        };

        // ... Keep existing updateDataLists, addSchedule, resetForm, deleteEntry, clearFullDatabase, sortTable, updateSortIcons ...
        window.updateDataLists = function() {
            const fields = ['subject', 'section', 'teacher', 'room'];
            fields.forEach(field => {
                const listElement = document.getElementById(`${field}List`);
                if(listElement) {
                    const uniqueValues = [...new Set(window.schedules.map(s => s[field]))].sort();
                    listElement.innerHTML = uniqueValues.map(v => `<option value="${v}">`).join('');
                }
            });
        };

        window.addSchedule = function() {
            const entry = {
                subject: document.getElementById('subject').value.trim().toUpperCase(),
                section: document.getElementById('section').value.trim().toUpperCase(),
                teacher: document.getElementById('teacher').value.trim().toUpperCase(),
                room: document.getElementById('room').value.trim().toUpperCase(),
                day: document.getElementById('day').value,
                start: document.getElementById('startTime').value,
                end: document.getElementById('endTime').value
            };
            if(!entry.subject || !entry.section || !entry.teacher || !entry.room) return alert("⚠️ Please fill in all fields.");
            const conflict = window.schedules.find(s => s.day === entry.day && (entry.start < s.end && entry.end > s.start) && (s.room === entry.room || s.teacher === entry.teacher || s.section === entry.section));
            if(conflict) return alert(`❌ CONFLICT: Already scheduled for ${conflict.subject}`);
            push(scheduleRef, entry);
            alert("✅ Data Saved Successfully!");
            resetForm();
        };

        window.resetForm = function() {
            document.getElementById('subject').value = ""; document.getElementById('section').value = "";
            document.getElementById('teacher').value = ""; document.getElementById('room').value = "";
            document.getElementById('startTime').value = "07:00"; document.getElementById('endTime').value = "08:00";
        };

        window.deleteEntry = function(key) { if(confirm("Delete this entry?")) remove(ref(db, `schedules/${key}`)); };

        window.clearFullDatabase = function() {
            const pass1 = confirm("❗ WARNING: This will ERASE ALL schedules.");
            if(pass1) { const pass2 = prompt("Type 'DELETE ALL' to confirm:"); if(pass2 === "DELETE ALL") set(scheduleRef, null); }
        };

        window.sortTable = function(field) {
            if (window.sortOrder.field === field) { window.sortOrder.asc = !window.sortOrder.asc; } 
            else { window.sortOrder.field = field; window.sortOrder.asc = true; }
            const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            window.schedules.sort((a, b) => {
                let valA = a[field]; let valB = b[field];
                if (field === 'day') { valA = dayOrder.indexOf(valA); valB = dayOrder.indexOf(valB); }
                if (valA < valB) return window.sortOrder.asc ? -1 : 1;
                if (valA > valB) return window.sortOrder.asc ? 1 : -1;
                return 0;
            });
            updateSortIcons(field);
            renderManageTable();
        };

        function updateSortIcons(activeField) {
            const icons = document.querySelectorAll('.sort-icon');
            icons.forEach(icon => { icon.className = 'fa-solid fa-sort sort-icon'; icon.style.opacity = "0.3"; });
            const activeIcon = document.getElementById(`icon-${activeField}`);
            activeIcon.className = window.sortOrder.asc ? 'fa-solid fa-sort-up sort-icon' : 'fa-solid fa-sort-down sort-icon';
            activeIcon.style.opacity = "1";
        }
    </script>

    <style>
        :root { --ark-dark: #0f172a; --ark-red: #be123c; --ark-green: #059669; --ark-orange: #d97706; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .main-container { max-width: 1300px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; }
        .branding-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .branding-logo { width: 85px; height: 85px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--ark-dark); }
        .branding-logo img { width: 100%; height: 100%; object-fit: contain; }
        .branding-text h1 { margin: 0; color: var(--ark-dark); font-size: 24px; letter-spacing: 1px; }
        .branding-text p { margin: 0; color: #64748b; font-size: 14px; font-weight: 600; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; background: var(--ark-dark); color: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 25px; }
        .btn-export { border: none; padding: 8px 15px; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .btn-clear { background: #444; color: #ff9999; border: 1px solid #ff4444; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; }
        .input-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .input-group { flex: 1; min-width: 120px; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: #475569; margin-bottom: 5px; text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; outline: none; box-sizing: border-box; }
        .btn-save { background: var(--ark-dark); color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: bold; cursor: pointer; height: 38px; }
        #captureArea { background: white; padding: 30px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .matrix-table { width: 100%; border-collapse: collapse; }
        .matrix-table th, .matrix-table td { border: 1px solid #e2e8f0; padding: 8px; font-size: 10px; text-align: center; }
        .matrix-table th { background: #334155; color: white; }
        .slot-box { background:#e0f2fe; padding:6px; border-radius:4px; color:#0369a1; font-size:9px; border-left:3px solid #0ea5e9; margin-bottom: 2px; line-height: 1.2; cursor: grab; user-select: none; }
        .slot-box:active { cursor: grabbing; }
        .manage-table th { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; padding: 15px; text-align: left; font-size: 12px; background: #f1f5f9; }
        .manage-table th:hover { background: #e2e8f0; }
        .sort-icon { margin-left: 8px; font-size: 10px; opacity: 0.3; }
        .capture-logo-small { width: 45px; height: 45px; border-radius: 50%; overflow: hidden; border: 1px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; }
        .capture-logo-small img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="branding-header">
        <div class="branding-logo"><img src="images/logo.png" alt="ARK Logo"></div>
        <div class="branding-text">
            <h1>ARK TECHNOLOGICAL INSTITUTE EDUCATION SYSTEM INC.</h1>
            <p>Class Schedule Maker</p>
        </div>
    </div>

    <div class="action-bar">
        <div>
            <h2 style="margin:0;">ARK EXPORT & DATABASE</h2>
            <p style="margin:0; font-size:12px; opacity:0.8;">Secure Schedule Control Panel</p>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn-clear" onclick="clearFullDatabase()"><i class="fa-solid fa-trash-can"></i> ERASE ALL DATA</button>
            <button class="btn-export" style="background:var(--ark-red);" onclick="downloadFullMatrix('pdf')">PDF Matrix</button>
            <button class="btn-export" style="background:var(--ark-green);" onclick="downloadFullMatrix('png')">PNG Matrix</button>
            <button class="btn-export" style="background:var(--ark-orange);" onclick="downloadMasterlist()">PDF Masterlist</button>
        </div>
    </div>

    <div class="input-card">
        <div class="input-row">
            <div class="input-group">
                <label>Subject</label><input id="subject" type="text" list="subjectList" placeholder="Type or Select..."><datalist id="subjectList"></datalist>
            </div>
            <div class="input-group">
                <label>Section</label><input id="section" type="text" list="sectionList" placeholder="Type or Select..."><datalist id="sectionList"></datalist>
            </div>
            <div class="input-group">
                <label>Teacher</label><input id="teacher" type="text" list="teacherList" placeholder="Type or Select..."><datalist id="teacherList"></datalist>
            </div>
            <div class="input-group">
                <label>Room</label><input id="room" type="text" list="roomList" placeholder="Type or Select..."><datalist id="roomList"></datalist>
            </div>
            <div class="input-group">
                <label>Day</label>
                <select id="day">
                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                    <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                </select>
            </div>
            <div class="input-group"><label>Start</label><input id="startTime" type="time" value="07:00"></div>
            <div class="input-group"><label>End</label><input id="endTime" type="time" value="08:00"></div>
            <div class="form-actions"><button class="btn-save" onclick="addSchedule()">SAVE DATA</button></div>
        </div>
    </div>

    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span style="font-weight: bold; font-size: 13px;">VIEW MODE:</span>
        <select id="modeSelect" onchange="updateFilterList()" style="padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1;">
            <option value="section">By Section</option>
            <option value="teacher">By Teacher</option>
            <option value="room">By Room</option>
        </select>
        <select id="filterSelector" onchange="renderMatrix()" style="padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; width: 220px;"></select>
        <span style="font-size: 11px; color: #64748b; margin-left: 10px;"><i class="fa-solid fa-hand-pointer"></i> Tip: Drag blocks to reschedule.</span>
    </div>

    <div id="captureArea">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
            <div class="capture-logo-small"><img src="images/logo.png" alt="Logo"></div>
            <div>
                <h4 style="margin:0; font-size: 14px;">ARK TECHNOLOGICAL INSTITUTE</h4>
                <p style="margin:0; font-size: 10px; color: #666;">Official Academic Schedule</p>
            </div>
        </div>
        <h3 id="matrixTitle" style="text-align: center; text-transform: uppercase; margin: 10px 0; color: var(--ark-dark); font-size: 16px;"></h3>
        <table class="matrix-table">
            <thead><tr><th>TIME</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th><th>SUN</th></tr></thead>
            <tbody id="matrixBody"></tbody>
        </table>
    </div>

    <div class="manage-section">
        <div class="table-controls" style="margin-top: 40px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0; color: var(--ark-red); border-left: 4px solid var(--ark-red); padding-left: 10px;">DATABASE MASTERLIST</h3>
            <div class="search-wrapper" style="position: relative;">
                <i class="fa-solid fa-filter" style="position: absolute; left: 12px; top: 12px; color: #94a3b8;"></i>
                <input type="text" id="tableSearch" class="search-input" style="padding: 10px 10px 10px 35px; border: 1px solid #cbd5e1; border-radius: 8px; width: 250px;" placeholder="Search Masterlist..." onkeyup="filterMasterlist()">
            </div>
        </div>
        <table class="manage-table" id="masterTable" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th onclick="sortTable('day')">Day <i id="icon-day" class="fa-solid fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('start')">Time <i id="icon-start" class="fa-solid fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('subject')">Subject <i id="icon-subject" class="fa-solid fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('section')">Section <i id="icon-section" class="fa-solid fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('teacher')">Instructor <i id="icon-teacher" class="fa-solid fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('room')">Room <i id="icon-room" class="fa-solid fa-sort sort-icon"></i></th>
                    <th style="cursor: default;">Action</th>
                </tr>
            </thead>
            <tbody id="manageBody"></tbody>
        </table>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    function updateFilterList() {
        const mode = document.getElementById('modeSelect').value;
        const sel = document.getElementById('filterSelector');
        const vals = [...new Set(window.schedules.map(s => s[mode]))].sort();
        sel.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        renderMatrix();
    }

    function renderMatrix() {
        const mode = document.getElementById('modeSelect').value;
        const filter = document.getElementById('filterSelector').value;
        const tbody = document.getElementById('matrixBody');
        document.getElementById('matrixTitle').innerText = filter ? `${mode}: ${filter}` : "SELECT A VIEW";
        tbody.innerHTML = '';
        if(!filter) return;

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        for (let h = 7; h <= 20; h++) {
            let hourStr = h.toString().padStart(2, '0') + ":00";
            let displayTime = h > 12 ? (h - 12) + ":00 PM" : (h === 12 ? "12:00 PM" : h + ":00 AM");
            
            let row = document.createElement('tr');
            row.innerHTML = `<td style="background:#f8fafc; font-weight:bold;">${displayTime}</td>`;
            
            days.forEach(day => {
                const cell = document.createElement('td');
                cell.className = 'matrix-cell';
                cell.setAttribute('ondragover', 'handleDragOver(event)');
                cell.setAttribute('ondragleave', 'handleDragLeave(event)');
                cell.setAttribute('ondrop', `handleDrop(event, '${day}', '${hourStr}')`);

                const matches = window.schedules.filter(s => s[mode] === filter && s.day === day && hourStr >= s.start && hourStr < s.end);
                
                matches.forEach(m => {
                    let info = (mode === 'teacher') ? m.section : (mode === 'section' ? m.teacher : m.section);
                    const slot = document.createElement('div');
                    slot.className = 'slot-box';
                    slot.draggable = true;
                    slot.setAttribute('ondragstart', `handleDragStart(event, '${m.firebaseKey}')`);
                    slot.setAttribute('ondragend', 'handleDragEnd(event)');
                    slot.innerHTML = `<b>${m.subject}</b><br><span style="font-size:8px;">(${info})</span>`;
                    cell.appendChild(slot);
                });
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        }
    }

    function renderManageTable() {
        document.getElementById('manageBody').innerHTML = window.schedules.map(s => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px 15px;">${s.day}</td>
                <td style="padding: 12px 15px;">${s.start}-${s.end}</td>
                <td style="padding: 12px 15px;"><b>${s.subject}</b></td>
                <td style="padding: 12px 15px; color:var(--ark-orange); font-weight:bold;">${s.section}</td>
                <td style="padding: 12px 15px; color:var(--ark-green);">${s.teacher}</td>
                <td style="padding: 12px 15px;">${s.room}</td>
                <td style="padding: 12px 15px;"><button onclick="deleteEntry('${s.firebaseKey}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
            </tr>
        `).join('');
    }

    function filterMasterlist() {
        const input = document.getElementById('tableSearch').value.toUpperCase();
        const rows = document.getElementById('manageBody').getElementsByTagName('tr');
        for (let row of rows) { row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none"; }
    }

    async function downloadFullMatrix(type) {
        const area = document.getElementById('captureArea');
        const canvas = await html2canvas(area, { scale: 2, useCORS: true, logging: false });
        const img = canvas.toDataURL('image/png');
        if(type === 'png') {
            const link = document.createElement('a'); link.href = img; link.download = 'ARK_Schedule.png'; link.click();
        } else {
            const pdf = new jsPDF('l', 'mm', 'a4');
            pdf.addImage(img, 'PNG', 10, 10, 277, 180);
            pdf.save("ARK_Official_Schedule.pdf");
        }
    }

    function downloadMasterlist() {
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFontSize(18);
        doc.text("ARK TECHNOLOGICAL INSTITUTE", 14, 20);
        doc.text("Official Masterlist", 14, 28);
        doc.autoTable({
            startY: 35,
            head: [['Day', 'Time', 'Subject', 'Section', 'Teacher', 'Room']],
            body: window.schedules.map(s => [s.day, `${s.start}-${s.end}`, s.subject, s.section, s.teacher, s.room]),
            theme: 'striped',
            headStyles: { fillColor: [15, 23, 42] }
        });
        doc.save("ARK_Masterlist.pdf");
    }
</script>
</body>
</html>
