<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Scheduler - ARK Technological Institute</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf-plugin-autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm0zv5xTNWqSyj4w34Je2yH1Er91iqvKs",
            authDomain: "myscheduler-624e9.firebaseapp.com",
            databaseURL: "https://myscheduler-624e9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myscheduler-624e9",
            storageBucket: "myscheduler-624e9.firebasestorage.app",
            messagingSenderId: "967010876778",
            appId: "1:967010876778:web:f427493c0aa40547383913"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const scheduleRef = ref(db, 'schedules');
        window.schedules = [];

        onValue(scheduleRef, (snapshot) => {
            const data = snapshot.val();
            window.schedules = data ? Object.values(data) : [];
            updateFilterList();
            renderMatrix();
        });

        window.addSchedule = function() {
            const entry = {
                id: Date.now(),
                subject: document.getElementById('subject').value,
                section: document.getElementById('section').value,
                teacher: document.getElementById('teacher').value,
                room: document.getElementById('room').value,
                day: document.getElementById('day').value,
                start: document.getElementById('startTime').value,
                end: document.getElementById('endTime').value
            };
            if(!entry.subject) return alert("Please enter a subject");
            push(scheduleRef, entry);
            alert("Saved Successfully!");
        };
    </script>

    <style>
        :root { --ark-red: #e11d48; --ark-blue: #1e293b; --accent: #2563eb; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* HEADER & DOWNLOAD BUTTONS */
        .admin-panel { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--ark-blue); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;
        }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-export { 
            border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; 
            font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 6px;
            transition: 0.3s;
        }
        .btn-pdf { background: var(--ark-red); color: white; }
        .btn-png { background: #059669; color: white; }
        .btn-master { background: #f59e0b; color: white; }
        .btn-export:hover { opacity: 0.8; transform: translateY(-2px); }

        /* FORM */
        .form-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 30px; background: #f1f5f9; padding: 20px; border-radius: 8px; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        
        /* THE VISUAL SCHEDULE (CAPTURE AREA) */
        #captureArea { background: white; padding: 30px; border: 1px solid #e2e8f0; width: 100%; box-sizing: border-box; }
        .inst-header { display: flex; align-items: center; justify-content: center; gap: 25px; border-bottom: 4px solid var(--ark-blue); padding-bottom: 20px; margin-bottom: 25px; }
        .inst-logo { height: 90px; width: auto; }
        .inst-title h1 { margin: 0; font-size: 26px; color: var(--ark-blue); text-transform: uppercase; letter-spacing: 1px; }
        .inst-title p { margin: 5px 0 0 0; font-size: 14px; color: #64748b; font-weight: bold; }

        .matrix-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .matrix-table th, .matrix-table td { border: 1px solid #cbd5e1; padding: 8px; font-size: 11px; text-align: center; overflow: hidden; }
        .matrix-table th { background: #334155; color: white; height: 40px; }
        .time-col { background: #f8fafc; font-weight: bold; width: 100px; color: var(--ark-blue); border-right: 2px solid #94a3b8; }
        .sched-item { background: #eff6ff; border-left: 4px solid var(--accent); padding: 6px; font-size: 10px; border-radius: 4px; color: #1e40af; margin-bottom: 2px; }
        
        .footer-note { margin-top: 25px; border-top: 1px solid #eee; padding-top: 10px; font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div>
            <h2 style="margin:0; font-size: 20px;">SYSTEM EXPORTER</h2>
            <p style="margin:0; font-size: 12px; opacity: 0.8;">ARK Technological Institute Education System Inc.</p>
        </div>
        <div class="btn-group">
            <button class="btn-export btn-pdf" onclick="exportMatrix('pdf')">üìÑ MATRIX PDF</button>
            <button class="btn-export btn-png" onclick="exportMatrix('png')">üñºÔ∏è MATRIX PNG</button>
            <button class="btn-export btn-master" onclick="downloadMasterPDF()">üìä MASTERLIST PDF</button>
        </div>
    </div>

    <div class="form-card">
        <div class="input-group"><label>Subject</label><input id="subject" type="text" placeholder="Subject Code"></div>
        <div class="input-group"><label>Section</label><input id="section" type="text" placeholder="Section"></div>
        <div class="input-group"><label>Teacher</label><input id="teacher" type="text" placeholder="Instructor"></div>
        <div class="input-group"><label>Room</label><input id="room" type="text" placeholder="Room No."></div>
        <div class="input-group"><label>Day</label>
            <select id="day">
                <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
            </select>
        </div>
        <div class="input-group"><label>Start</label><input id="startTime" type="time" value="07:00"></div>
        <div class="input-group"><label>End</label><input id="endTime" type="time" value="08:00"></div>
        <button onclick="addSchedule()" style="background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; height: 40px; align-self: end;">SAVE DATA</button>
    </div>

    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <span style="font-weight: bold; color: var(--ark-blue);">Filtering:</span>
        <select id="modeSelect" onchange="updateFilterList()" style="width: 150px;"><option value="section">By Section</option><option value="teacher">By Teacher</option><option value="room">By Room</option></select>
        <select id="filterSelector" onchange="renderMatrix()" style="width: 250px; border-color: var(--accent);"></select>
    </div>

    <div id="captureArea">
        <div class="inst-header">
            <img src="images/logo.png" alt="ARK LOGO" class="inst-logo" onerror="this.src='https://via.placeholder.com/100x100?text=ARK+LOGO'">
            <div class="inst-title">
                <h1>ARK Technological Institute Education System Inc.</h1>
                <p>OFFICIAL ACADEMIC SCHEDULE REPORT</p>
            </div>
        </div>

        <h2 id="matrixTitle" style="text-align: center; color: var(--ark-blue); margin: 0 0 20px 0; font-size: 22px; text-transform: uppercase;"></h2>
        
        <table class="matrix-table">
            <thead>
                <tr>
                    <th class="time-col">TIME SLOT</th>
                    <th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th><th>SUN</th>
                </tr>
            </thead>
            <tbody id="matrixBody"></tbody>
        </table>
        
        <div class="footer-note">
            <span>Generated on: <b id="genDate"></b></span>
            <span>This is an official document of ARK Technological Institute Education System Inc.</span>
        </div>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    function updateFilterList() {
        const mode = document.getElementById('modeSelect').value;
        const sel = document.getElementById('filterSelector');
        const vals = [...new Set(window.schedules.map(s => s[mode]))].sort();
        sel.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        renderMatrix();
    }

    function renderMatrix() {
        const mode = document.getElementById('modeSelect').value;
        const filter = document.getElementById('filterSelector').value;
        const tbody = document.getElementById('matrixBody');
        document.getElementById('matrixTitle').innerText = filter ? `${mode}: ${filter}` : "Please Select Item";
        document.getElementById('genDate').innerText = new Date().toLocaleString();
        tbody.innerHTML = '';
        
        if(!filter) return;

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        // Schedule from 7 AM to 8 PM (20:00)
        for (let h = 7; h <= 20; h++) {
            let hourStr = h.toString().padStart(2, '0') + ":00";
            let displayTime = h > 12 ? (h - 12) + ":00 PM" : (h === 12 ? "12:00 PM" : h + ":00 AM");
            let row = `<tr><td class="time-col">${displayTime}</td>`;
            
            days.forEach(day => {
                const matches = window.schedules.filter(s => 
                    s[mode] === filter && s.day === day && hourStr >= s.start && hourStr < s.end
                );
                
                let content = matches.map(m => `
                    <div class="sched-item">
                        <b>${m.subject}</b><br>
                        ${m.room} | ${m.teacher}
                    </div>
                `).join('');
                
                row += `<td>${content}</td>`;
            });
            tbody.innerHTML += row + "</tr>";
        }
    }

    // ENHANCED EXPORT: Matrix View (Full Cover)
    async function exportMatrix(format) {
        const area = document.getElementById('captureArea');
        const filterVal = document.getElementById('filterSelector').value || "Schedule";
        
        // Capture everything without cropping
        const canvas = await html2canvas(area, {
            scale: 3, // High resolution
            useCORS: true,
            logging: false,
            windowWidth: area.scrollWidth,
            windowHeight: area.scrollHeight
        });

        const imgData = canvas.toDataURL('image/png');

        if (format === 'png') {
            const link = document.createElement('a');
            link.download = `ARK_Schedule_${filterVal}.png`;
            link.href = imgData;
            link.click();
        } else {
            const pdf = new jsPDF('l', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pageWidth - 20;
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            // If the schedule is very long, adjust PDF page height to fit everything (No Cropping)
            if (pdfHeight > pageHeight) {
                const longPdf = new jsPDF('l', 'mm', [pdfHeight + 20, pageWidth]);
                longPdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                longPdf.save(`ARK_Schedule_${filterVal}.pdf`);
            } else {
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                pdf.save(`ARK_Schedule_${filterVal}.pdf`);
            }
        }
    }

    // EXPORT: Masterlist Table View
    function downloadMasterPDF() {
        const pdf = new jsPDF('l', 'mm', 'a4');
        
        // Institutional Header
        pdf.setFontSize(18);
        pdf.setTextColor(30, 41, 59);
        pdf.text("ARK Technological Institute Education System Inc.", 14, 15);
        
        pdf.setFontSize(11);
        pdf.setTextColor(100, 116, 139);
        pdf.text("ACADEMIC MASTERLIST - FULL DATABASE REPORT", 14, 22);
        pdf.line(14, 25, 283, 25); 
        
        const data = window.schedules.map(s => [s.day, `${s.start} - ${s.end}`, s.subject, s.teacher, s.section, s.room]);
        
        pdf.autoTable({
            head: [['Day', 'Time Slot', 'Subject', 'Instructor', 'Section', 'Room/Lab']],
            body: data,
            startY: 30,
            theme: 'grid',
            headStyles: { fillColor: [30, 41, 59], fontSize: 10, halign: 'center' },
            styles: { fontSize: 9, cellPadding: 4 },
            columnStyles: {
                0: { cellWidth: 30 },
                1: { cellWidth: 40 },
                2: { fontStyle: 'bold' }
            }
        });
        
        pdf.save("ARK_Masterlist_Database.pdf");
    }
</script>

</body>
</html>
