<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK - Academic Scheduler Professional</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm0zv5xTNWqSyj4w34Je2yH1Er91iqvKs",
            authDomain: "myscheduler-624e9.firebaseapp.com",
            databaseURL: "https://myscheduler-624e9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myscheduler-624e9",
            storageBucket: "myscheduler-624e9.firebasestorage.app",
            messagingSenderId: "967010876778",
            appId: "1:967010876778:web:f427493c0aa40547383913"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const scheduleRef = ref(db, 'schedules');
        window.schedules = [];

        onValue(scheduleRef, (snapshot) => {
            const data = snapshot.val();
            window.schedules = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            updateFilterList(document.getElementById('filterSelector').value); 
            updateDataLists(); 
            renderManageTable();
        });

        // --- CONFLICT DETECTION LOGIC ---
        function isConflict(newEntry) {
            return window.schedules.find(existing => {
                if (existing.day !== newEntry.day) return false;
                const start1 = newEntry.start;
                const end1 = newEntry.end;
                const start2 = existing.start;
                const end2 = existing.end;
                const isOverlapping = (start1 < end2 && end1 > start2);

                if (isOverlapping) {
                    if (existing.teacher === newEntry.teacher) return `INSTRUCTOR CONFLICT: ${existing.teacher} is busy.`;
                    if (existing.room === newEntry.room && newEntry.room !== "ONLINE") return `ROOM CONFLICT: Room ${existing.room} is occupied.`;
                    if (existing.section === newEntry.section) return `SECTION CONFLICT: ${existing.section} has a class.`;
                }
                return false;
            });
        }

        window.addSchedule = () => {
            const entry = {
                subject: document.getElementById('subject').value.trim().toUpperCase(),
                section: document.getElementById('section').value.trim().toUpperCase(),
                teacher: document.getElementById('teacher').value.trim().toUpperCase(),
                room: document.getElementById('room').value.trim().toUpperCase(),
                day: document.getElementById('day').value,
                start: document.getElementById('startTime').value,
                end: document.getElementById('endTime').value
            };

            if(!entry.subject || !entry.section || !entry.start || !entry.end) {
                return alert("Please fill in all required fields.");
            }
            if(entry.start >= entry.end) return alert("Error: Start time must be before End time.");

            const conflictMessage = isConflict(entry);
            if(conflictMessage) {
                alert("⚠️ CANNOT SAVE \n" + conflictMessage);
                return;
            }

            push(scheduleRef, entry);
            alert("Saved Successfully!");
        };

        // --- DRAG AND DROP ---
        window.handleDragStart = (e, k) => { e.dataTransfer.setData("text", k); e.target.style.opacity = "0.4"; };
        window.handleDragEnd = (e) => e.target.style.opacity = "1";
        window.handleDragOver = (e) => { e.preventDefault(); e.currentTarget.style.background = "#f0fdf4"; };
        window.handleDragLeave = (e) => e.currentTarget.style.background = "";
        window.handleDrop = (e, day, start) => {
            e.preventDefault();
            const key = e.dataTransfer.getData("text");
            const entry = window.schedules.find(s => s.firebaseKey === key);
            if(!entry) return;

            const [sh, sm] = entry.start.split(':').map(Number);
            const [eh, em] = entry.end.split(':').map(Number);
            const dur = (eh * 60 + em) - (sh * 60 + sm);
            const [nh, nm] = start.split(':').map(Number);
            const totalEnd = (nh * 60 + nm) + dur;
            const end = `${Math.floor(totalEnd/60).toString().padStart(2,'0')}:${(totalEnd%60).toString().padStart(2,'0')}`;
            
            const newPos = { ...entry, day, start, end };
            const tempSchedules = window.schedules.filter(s => s.firebaseKey !== key);
            const conflict = tempSchedules.find(existing => {
                if (existing.day !== newPos.day) return false;
                const isOverlapping = (newPos.start < existing.end && newPos.end > existing.start);
                if (isOverlapping) {
                    if (existing.teacher === newPos.teacher) return true;
                    if (existing.room === newPos.room && newPos.room !== "ONLINE") return true;
                    if (existing.section === newPos.section) return true;
                }
                return false;
            });

            if(conflict) return alert("Cannot move: Conflict detected at new time slot.");
            update(ref(db, `schedules/${key}`), { day, start, end });
        };

        window.deleteEntry = (k) => { if(confirm("Delete this entry?")) remove(ref(db, `schedules/${k}`)); };
    </script>

    <style>
        :root { --ark-dark: #0f172a; --ark-accent: #3b82f6; --ark-border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #1e293b; }
        .main-container { max-width: 1400px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 25px; }
        
        /* Institutional Header */
        .matrix-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 3px solid var(--ark-dark); }
        .matrix-header img { width: 70px; height: 70px; object-fit: contain; }
        .matrix-header-text h2 { margin: 0; font-size: 24px; color: var(--ark-dark); letter-spacing: 1px; }
        .matrix-header-text p { margin: 0; font-size: 13px; font-weight: 700; color: #64748b; text-transform: uppercase; }

        /* Controls bar */
        .action-bar { display: flex; justify-content: space-between; align-items: center; background: var(--ark-dark); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; }
        .btn-export { border: none; padding: 8px 16px; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .btn-export:hover { opacity: 0.9; }

        /* DATA ENCODING SECTION - ENHANCED */
        .input-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-group input, .input-group select { 
            width: 100%; padding: 10px 12px; border: 2px solid #f1f5f9; border-radius: 8px; 
            font-size: 14px; font-weight: 500; color: #1e293b; background-color: #f8fafc; 
            transition: all 0.2s ease; box-sizing: border-box; height: 44px; 
        }
        .input-group input:focus { outline: none; border-color: var(--ark-accent); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn-save { background: var(--ark-dark); color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: 700; cursor: pointer; height: 44px; font-size: 12px; text-transform: uppercase; }

        /* Matrix Styling */
        .matrix-table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 1px solid #cbd5e1; }
        .matrix-table th, .matrix-table td { border: 1px solid #e2e8f0; padding: 4px; text-align: center; height: 50px; position: relative; }
        .matrix-table th { background: #334155; color: white; font-size: 11px; text-transform: uppercase; }
        .time-col { background: #f8fafc; font-weight: 800; color: #0f172a; width: 140px !important; border-right: 2px solid #cbd5e1; font-size: 10px; }

        .slot-box { 
            padding: 6px; border-radius: 4px; font-size: 9px; margin: 2px; cursor: grab; 
            border-left: 4px solid; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; line-height: 1.3;
        }
        .slot-box strong { font-size: 10px; margin-bottom: 2px; }

        .manage-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        .manage-table th { background: #f1f5f9; padding: 12px; text-align: left; color: #475569; }
        .manage-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="matrix-header">
        <img src="images/logo.png" alt="Logo" onerror="this.src='https://via.placeholder.com/70?text=ARK'">
        <div class="matrix-header-text">
            <h2>ARK TECHNOLOGICAL INSTITUTE EDUCATION SYSTEM INC.</h2>
            <p>Class Schedule Maker</p>
        </div>
    </div>

    <div class="action-bar">
        <div style="font-size: 13px; font-weight: 600;"><i class="fa-solid fa-layer-group"></i> SCHEDULER CONTROLS</div>
        <div style="display:flex; gap:8px;">
            <button class="btn-export" style="background:#dc2626;" onclick="downloadFullMatrix('pdf')"><i class="fa-solid fa-file-pdf"></i> EXPORT PDF</button>
            <button class="btn-export" style="background:#16a34a;" onclick="downloadFullMatrix('png')"><i class="fa-solid fa-image"></i> EXPORT PNG</button>
            <button class="btn-export" style="background:#15803d;" onclick="downloadExcelMasterlist()"><i class="fa-solid fa-file-excel"></i> MASTERLIST</button>
        </div>
    </div>

    <div class="input-card">
        <div class="input-row">
            <div class="input-group">
                <label>Subject</label>
                <input id="subject" type="text" list="subjectList" placeholder="e.g. MATH 101">
                <datalist id="subjectList"></datalist>
            </div>
            <div class="input-group">
                <label>Section</label>
                <input id="section" type="text" list="sectionList" placeholder="e.g. BSIT-1A">
                <datalist id="sectionList"></datalist>
            </div>
            <div class="input-group">
                <label>Instructor</label>
                <input id="teacher" type="text" list="teacherList" placeholder="Enter Name">
                <datalist id="teacherList"></datalist>
            </div>
            <div class="input-group">
                <label>Room</label>
                <input id="room" type="text" list="roomList" placeholder="e.g. LAB 1">
                <datalist id="roomList"></datalist>
            </div>
            <div class="input-group">
                <label>Day</label>
                <select id="day">
                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                    <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                </select>
            </div>
            <div class="input-group">
                <label>Start</label>
                <input id="startTime" type="time" value="07:00">
            </div>
            <div class="input-group">
                <label>End</label>
                <input id="endTime" type="time" value="08:00">
            </div>
            <button class="btn-save" onclick="addSchedule()">Save Entry</button>
        </div>
    </div>

    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 12px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <span style="font-weight: 800; font-size: 11px; color: #64748b;">VIEW MODE:</span>
        <select id="modeSelect" onchange="updateFilterList()" style="padding: 6px; font-size: 12px; border-radius: 4px; border: 1px solid #cbd5e1;">
            <option value="section">Filter by Section</option>
            <option value="teacher">Filter by Instructor</option>
            <option value="room">Filter by Room</option>
        </select>
        <select id="filterSelector" onchange="renderMatrix()" style="padding: 6px; font-size: 12px; width: 250px; font-weight: bold; border-radius: 4px; border: 2px solid #3b82f6;"></select>
    </div>

    <div id="captureArea" style="background:white; padding:20px; border: 1px solid #e2e8f0; border-radius: 8px;">
        <div class="matrix-header">
            <img src="images/logo.png" alt="Logo" onerror="this.src='https://via.placeholder.com/70?text=ARK'">
            <div class="matrix-header-text">
                <h2>ARK TECHNOLOGICAL INSTITUTE EDUCATION SYSTEM INC.</h2>
                <p>Class Schedule</p>
            </div>
        </div>
        <h3 id="matrixTitle" style="text-align: center; margin: 15px 0; font-size: 16px; color: #1e293b; text-transform: uppercase; font-weight: 800;"></h3>
        <table class="matrix-table">
            <thead>
                <tr>
                    <th style="width: 140px;">TIME SLOT</th>
                    <th>MONDAY</th><th>TUESDAY</th><th>WEDNESDAY</th><th>THURSDAY</th><th>FRIDAY</th><th>SATURDAY</th><th>SUNDAY</th>
                </tr>
            </thead>
            <tbody id="matrixBody"></tbody>
        </table>
    </div>

    <div class="manage-section" style="margin-top: 40px;">
        <h3 style="font-size: 15px; display: flex; align-items: center; gap: 10px; color: #0f172a;">
            <i class="fa-solid fa-database"></i> MASTER DATABASE MASTERLIST
        </h3>
        <table class="manage-table">
            <thead>
                <tr><th>DAY</th><th>TIME</th><th>SUBJECT</th><th>SECTION</th><th>TEACHER</th><th>ROOM</th><th>ACTION</th></tr>
            </thead>
            <tbody id="manageBody"></tbody>
        </table>
    </div>
</div>

<script>
    function formatTimeAMPM(h) {
        let hh = h % 12 || 12;
        let suffix = h >= 12 ? "PM" : "AM";
        return `${hh}:00 ${suffix}`;
    }

    function getTeacherColor(name) {
        let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash) % 360;
        return { bg: `hsl(${h}, 80%, 97%)`, border: `hsl(${h}, 70%, 45%)`, text: `hsl(${h}, 70%, 15%)` };
    }

    window.updateFilterList = (val) => {
        const m = document.getElementById('modeSelect').value;
        const vals = [...new Set(window.schedules.map(s => s[m]))].sort();
        const sel = document.getElementById('filterSelector');
        sel.innerHTML = vals.map(v => `<option value="${v}">${v}</option>`).join('');
        if(val && vals.includes(val)) sel.value = val;
        renderMatrix();
    };

    function renderMatrix() {
        const m = document.getElementById('modeSelect').value;
        const f = document.getElementById('filterSelector').value;
        const body = document.getElementById('matrixBody');
        document.getElementById('matrixTitle').innerText = f ? `${m}: ${f}` : "--- SELECT A FILTER TO VIEW SCHEDULE ---";
        body.innerHTML = '';
        if(!f) return;

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        for (let h = 7; h <= 18; h++) { // Expanded to 7PM
            let tr = document.createElement('tr');
            let hourStr = h.toString().padStart(2, '0') + ":00";
            let timeLabel = `${formatTimeAMPM(h)} - ${formatTimeAMPM(h+1)}`;
            tr.innerHTML = `<td class="time-col">${timeLabel}</td>`;
            
            days.forEach(day => {
                let td = document.createElement('td');
                td.className = 'matrix-cell';
                td.setAttribute('ondragover', 'handleDragOver(event)');
                td.setAttribute('ondrop', `handleDrop(event, '${day}', '${hourStr}')`);

                window.schedules.filter(s => s[m] === f && s.day === day && hourStr >= s.start && hourStr < s.end).forEach(item => {
                    const c = getTeacherColor(item.teacher);
                    let info = m === 'section' ? `${item.teacher}<br>${item.room}` : 
                               (m === 'room' ? `${item.section}<br>${item.teacher}` : `${item.section}<br>${item.room}`);
                    
                    let div = document.createElement('div');
                    div.className = 'slot-box';
                    div.draggable = true;
                    div.style.backgroundColor = c.bg;
                    div.style.borderColor = c.border;
                    div.style.color = c.text;
                    div.setAttribute('ondragstart', `handleDragStart(event, '${item.firebaseKey}')`);
                    div.innerHTML = `<strong>${item.subject}</strong><span>${info}</span>`;
                    td.appendChild(div);
                });
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
    }

    window.updateDataLists = () => {
        ['subject', 'section', 'teacher', 'room'].forEach(f => {
            const list = document.getElementById(`${f}List`);
            const vals = [...new Set(window.schedules.map(s => s[f]))].sort();
            if(list) list.innerHTML = vals.map(v => `<option value="${v}">`).join('');
        });
    };

    function renderManageTable() {
        document.getElementById('manageBody').innerHTML = window.schedules.map(s => `
            <tr>
                <td><b>${s.day.substring(0,3)}</b></td>
                <td>${s.start} - ${s.end}</td>
                <td><span style="color:#2563eb;font-weight:700;">${s.subject}</span></td>
                <td>${s.section}</td>
                <td>${s.teacher}</td>
                <td>${s.room}</td>
                <td><button onclick="deleteEntry('${s.firebaseKey}')" style="background:none;border:none;color:#ef4444;cursor:pointer;"><i class="fa-solid fa-trash-can"></i></button></td>
            </tr>
        `).join('');
    }

    window.downloadFullMatrix = async (type) => {
        const area = document.getElementById('captureArea');
        const canvas = await html2canvas(area, { scale: 3 });
        const img = canvas.toDataURL('image/png');
        if(type === 'png') {
            const l = document.createElement('a'); l.href = img; l.download = `Schedule_${document.getElementById('filterSelector').value}.png`; l.click();
        } else {
            const { jsPDF } = window.jspdf;
            const p = new jsPDF('l', 'mm', 'a4'); 
            p.addImage(img, 'PNG', 5, 5, 287, 0); 
            p.save(`Schedule_${document.getElementById('filterSelector').value}.pdf`);
        }
    };

    window.downloadExcelMasterlist = () => {
        const ws = XLSX.utils.json_to_sheet(window.schedules);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Masterlist");
        XLSX.writeFile(wb, "ARK_Masterlist.xlsx");
    };
</script>
</body>
</html>
